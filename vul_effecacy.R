library(tidyverse)
library(extrafont)
library(openxlsx)
library(magrittr)
library(tidyverse)
library(mboost)
library(mltools)
library(pROC)
library(plotROC)
library(pROC)
library(stringi)
library(questionr)
library(randomForest)
library(gbm)
library(neuralnet)
library(e1071)
library(gridExtra)
library(tictoc)

# font_import(prompt = FALSE, pattern = 'times')
# loadfonts(device = 'win')
# windowsFonts()

# helper functions
myApply <- function(X, FUN, ...) {
  myFun <- function(...) {
    library("mboost") # load mboost on nodes
    FUN(...)
  }
  ## further set up steps as required
  parLapply(cl = cl, X, myFun, ...)
}

clean_names <- function(data_to_clean) {
  data_to_clean %>%
    mutate(
      variable = str_replace_all(variable, "S1.3a", "Climate change acceptance"),
      variable = str_replace_all(variable, "S8.4a", "Dependent on farm"),
      variable = str_replace_all(variable, "reg", "Natural assets"),
      variable = str_replace_all(variable, "S1.9a", "Trust in newspapers"),
      variable = str_replace_all(variable, "S1.9b", "Trust in farming journals"),
      variable = str_replace_all(variable, "S1.9c", "Trust in TV"),
      variable = str_replace_all(variable, "S1.9d", "Trust in radio"),
      variable = str_replace_all(variable, "S1.9e", "Trust in internet"),
      variable = str_replace_all(variable, "S1.9f", "Trust in extension workers"),
      variable = str_replace_all(variable, "S1.9g", "Trust in government workers"),
      variable = str_replace_all(variable, "S1.9h", "Trust in neighbours"),
      variable = str_replace_all(variable, "S1.9i", "Trust in industry"),
      variable = str_replace_all(variable, "S1.9j", "Trust in farm associations"),
      variable = str_replace_all(variable, "S1.8a", "Use of newspapers"),
      variable = str_replace_all(variable, "S1.8b", "Use of farming journals"),
      variable = str_replace_all(variable, "S1.8c", "Use of TV"),
      variable = str_replace_all(variable, "S1.8d", "Use of radio"),
      variable = str_replace_all(variable, "S1.8e", "Use of internet"),
      variable = str_replace_all(variable, "S1.8f", "Use of extension workers"),
      variable = str_replace_all(variable, "S1.8g", "Use of government workers"),
      variable = str_replace_all(variable, "S1.8h", "Use of neighbours"),
      variable = str_replace_all(variable, "S1.8i", "Use of industry"),
      variable = str_replace_all(variable, "S1.8j", "Use of farm associations"),
      variable = str_replace_all(variable, "S8.1c", "Gender"),
      variable = str_replace_all(variable, "S8.1d", "Education"),
      variable = str_replace_all(variable, "S5.17a", "Trust in government institutions"),
      variable = str_replace_all(variable, "S5.17c", "Trust in religion"),
      variable = str_replace_all(variable, "S5.17d", "Trust in fate"),
      variable = str_replace_all(variable, "S8.6a", "Farm size"),
      variable = str_replace_all(variable, "S8.2balternative", "Prior ownership (family)"),
      variable = str_replace_all(variable, "S8.14", "Farm debt load"),
      variable = str_replace_all(variable, "S8.1b", "Age > 50"),
      variable = str_replace_all(variable, "S3.3", "Income invested"),
      variable = str_replace_all(variable, "S8.4b", "Family farm engagement"),
      variable = str_replace_all(variable, "A3", "Agronomic measures"),
      variable = str_replace_all(variable, "S8.6e", "Other products"),
      variable = str_replace_all(variable, "F3", "Economic measures"),
      variable = str_replace_all(variable, "T3", "Technological measures"),
      variable = str_replace_all(variable, "S1.3d", "Climate extremes"),
      variable = str_replace_all(variable, "S1.3b", "Human cause climate change"),
      variable = str_replace_all(variable, "S5.17b", "Trust in other farmers"),
      variable = str_replace_all(variable, "S8.6c", "More than one variety grown"),
      variable = str_replace_all(variable, "S2.1a1", "Increasing temperature"),
      variable = str_replace_all(variable, "S8.11_well", "Use of well irrigation"),
      variable = str_replace_all(variable, "S8.11_river", "Use of river irrigation"),
      variable = str_replace_all(variable, "S2.1d1", "Increasing extreme weather"),
      variable = str_replace_all(variable, "S8.2a2", "Years of farm possession"),
      variable = str_replace_all(variable, "S1.8d", "Trust in internet"),
      variable = str_replace_all(variable, "S2.1b3", "Decreasing rainfall"),
      variable = str_replace_all(variable, "S2.1c1", "Increasing drought"),
      variable = str_replace_all(variable, "S2.2c_pr", "Summer temperature proximity"),
      variable = str_replace_all(variable, "S2.3c_pr", "Winter temperature proximity"),
      variable = str_replace_all(variable, "S2.4c_pr", "Decreasing rainfall proximity"),
      variable = str_replace_all(variable, "S2.5c_pr", "Drought proximity"),
      variable = str_replace_all(variable, "S2.6c_pr", "Extreme weather proximity"),
      variable = str_replace_all(variable, "S2.2c_no", "No summer temperature vulnerability"),
      variable = str_replace_all(variable, "S2.3c_no", "No winter temperature vulnerability"),
      variable = str_replace_all(variable, "S2.4c_no", "No decreasing rainfall vulnerability"),
      variable = str_replace_all(variable, "S2.5c_no", "No drought vulnerability"),
      variable = str_replace_all(variable, "S2.6c_no", "No Extreme weather vulnerability"),
      variable = str_replace_all(variable, "S2.2c", "Summer temperature vulnerability"),
      variable = str_replace_all(variable, "S2.3c", "Winter temperature vulnerability"),
      variable = str_replace_all(variable, "S2.4c", "Decreasing rainfall vulnerability"),
      variable = str_replace_all(variable, "S2.5c", "Drought vulnerability"),
      variable = str_replace_all(variable, "S2.6c", "Extreme weather vulnerability"),
      variable = str_replace_all(variable, "S8.3b", "Years of farm managing"),
      variable = str_replace_all(variable, "S8.6b", "Orchard size"),
      variable = str_replace_all(variable, "S8.13_low", "Low financial wellbeing"),
      variable = str_replace_all(variable, "S8.13", "High financial wellbeing"),
      variable = str_replace_all(variable, "S1.1b", "Work independent"),
      variable = str_replace_all(variable, "S1.1c", "Keep tradition alive"),
      variable = str_replace_all(variable, "S1.1d", "Provide good living environment"),
      variable = str_replace_all(variable, "S1.1e", "Be in profitable business"),
      variable = str_replace_all(variable, "S1.2a", "Climate change is harmful"),
      variable = str_replace_all(variable, "S1.2c", "High optimism"),
      variable = str_replace_all(variable, "S1.3f", "High certainty"),
      variable = str_replace_all(variable, "S2.7", "Crop damage near farms"),
      variable = str_replace_all(variable, "S2.8", "Crop damage farms in Country"),
      variable = str_replace_all(variable, "S3.1a", "Climate change occurs"),
      variable = str_replace_all(variable, "S3.1b", "Climate threatens farm"),
      variable = str_replace_all(variable, "S3.1c", "Climate risks > benefits"),
      variable = str_replace_all(variable, "S3.4", "Adaptive measures efficacy"),
      variable = str_replace_all(variable, "S3.5", "Adapive measures near farms"),
    ) %>%
    return()
}
prepare_sgb <- function(alpha = 0.5, local_df = 1, index_df, blearner = "bols",
                        outcome_name = "y") {
  formula_frame <- index_df
  formula_frame$degf <- local_df
  formula_frame <- formula_frame %>%
    group_by(index) %>%
    mutate(degf = degf / sum(degf)) %>%
    ungroup() %>%
    mutate(degf = degf * length(index_df$index) / length(unique(index_df$index))) %>%
    mutate(
      degf = local_df * degf / (max(degf)),
      term = paste0(blearner, "(", sgl_name, ", df = ", degf * alpha, ")")
    )
  formula <- paste0(formula_frame$term, collapse = "+")
  formula_group <- formula_frame %>%
    group_by(index) %>%
    summarize(sgl_name = paste0(sgl_name, collapse = " , "), degf = mean(degf) * (1 - alpha)) %>%
    mutate(term = paste0(blearner, "(", sgl_name, ", df = ", degf, ")"))
  formula_group <- paste0(formula_group$term, collapse = " + ")
  final_formula <- paste0(formula, " + ", formula_group)
  if (alpha == 0) {
    final_formula <- formula_group
  }
  return(final_formula)
}
# Data manipulation and cleaning start

df_raw <- read.csv("df_raw.csv") %>%
  mutate(
    "A5" = S5.5a | S5.5c | S5.5d | S5.5e | S5.5m,
    "F5" = S5.5i | S5.5j | S5.5k | S5.5l,
    "T5" = S5.5b | S5.5f | S5.5g | S5.5h,
    "O5" = case_when(is.na(S3.2n) ~ F, T ~ T),
    "A3" = S3.2a | S3.2c | S3.2d | S3.2e | S3.2m,
    "F3" = S3.2i | S3.2j | S3.2k | S3.2l,
    "T3" = S3.2b | S3.2f | S3.2g | S3.2h,
    "O3" = S3.2m,
    S4.7 = as.character(S4.7),
    S7.1alternative = as.character(S7.1alternative),
    S7.1 = as.character(S7.1)
  ) %>%
  mutate(
    "A5" = case_when(S5.5n == "1_A" ~ T, S5.5n == "1_P" ~ T, T ~ A5),
    "T5" = case_when(
      S5.5n == "2_WAT" ~ T, S5.5n == "2_TPS" ~ T, S5.5n == "2_F" ~ T,
      S5.5n == "2_OTH" ~ T, S5.5n == "2_WIND" ~ T, T ~ T5
    ),
    "F5" = case_when(S5.5n == "3_FFR" ~ T, S5.5n == "4_MAN" ~ T, S5.5n == "4_AGR" ~ T, T ~ F5)
  ) %>%
  mutate(
    "A3" = case_when(S3.2n == "1_A" ~ T, S3.2n == "1_P" ~ T, T ~ A3),
    "T3" = case_when(
      S3.2n == "2_WAT" ~ T, S3.2n == "2_IRR" ~ T, S3.2n == "2_TPS" ~ T, S3.2n == "2_F" ~ T,
      S3.2n == "2_OTH" ~ T, S3.2n == "2_WIND" ~ T, T ~ T3
    ),
    "F3" = case_when(S3.2n == "3_FFR" ~ T, S3.2n == "4_MAN" ~ T, S3.2n == "4_AGR" ~ T, T ~ F3)
  ) %>%
  select(-contains("S3.2")) %>%
  mutate(
    S4.2d = as.numeric(S4.2d),
    S4.2e = as.numeric(S4.2e),
    S4.7 = case_when(
      str_detect(S4.7, "1_") ~ "1",
      str_detect(S4.7, "2_") ~ "2",
      str_detect(S4.7, "3_") ~ "3",
      str_detect(S4.7, "4_") ~ "4",
      str_detect(S4.7, "48") ~ "NA",
      T ~ S4.7
    ),
    S4.3a = case_when(
      str_detect(S4.3a, "1_") ~ "1",
      str_detect(S4.3a, "2_") ~ "2",
      str_detect(S4.3a, "3_") ~ "3",
      str_detect(S4.3a, "4_") ~ "4",
      T ~ NA_character_
    ),
    S4.3b = case_when(
      str_detect(S4.3b, "1_") ~ "1",
      str_detect(S4.3b, "2_") ~ "2",
      str_detect(S4.3b, "3_") ~ "3",
      str_detect(S4.3b, "4_") ~ "4",
      T ~ NA_character_
    ),
    S1.2a = case_when(
      str_detect(S1.2a, "1_") ~ "1",
      str_detect(S1.2a, "2_") ~ "2",
      str_detect(S1.2a, "3_") ~ "3",
      str_detect(S1.2a, "4_") ~ "4",
      T ~ S4.7
    ),
    S1.2b1 = case_when(
      str_detect(S1.2b1, "1_") ~ "1",
      str_detect(S1.2b1, "2_") ~ "2",
      str_detect(S1.2b1, "3_") ~ "3",
      str_detect(S1.2b1, "4_") ~ "4",
      T ~ S4.7
    ),
    S7.1alternative = case_when(
      str_detect(S7.1alternative, "1_") ~ "1",
      str_detect(S7.1alternative, "2_") ~ "2",
      str_detect(S7.1alternative, "3_") ~ "3",
      str_detect(S7.1alternative, "4_") ~ "4",
      str_detect(S7.1alternative, "5_") ~ "5",
      str_detect(S7.1alternative, "6_") ~ "6",
      T ~ S7.1alternative
    ),
    S7.1 = case_when(
      str_detect(S7.1, "1_") ~ "1",
      str_detect(S7.1, "2_") ~ "2",
      str_detect(S7.1, "3_") ~ "3",
      str_detect(S7.1, "4_") ~ "4",
      str_detect(S7.1, "5_") ~ "5",
      str_detect(S7.1, "6_") ~ "6",
      T ~ S7.1
    ),
    S8.2a2 = relevel(factor(case_when(
      S8.2a2 >= 1 ~ 'TRUE', T ~ 'FALSE'
    )), ref = "FALSE")
  ) %>%
  mutate(
    S5.9 = case_when(S5.9 >= 4 ~ T, T ~ F),
    S5.7 = case_when(S5.7 >= 4 ~ T, T ~ F),
    S5.8 = case_when(S5.8 >= 4 ~ T, T ~ F),
    S5.6p = !is.na(S5.6p)
  ) %>%
  mutate(
    reg = case_when(
      RegionsDetail == 16 ~ "SouthernChile",
      RegionsDetail %in% c(6, 7, 13) ~ "CentralChile",
      RegionsDetail == 1 ~ "CentralTunisia",
      RegionsDetail == 2 ~ "NorthernTunisia"
    ),
    Regions = case_when(
      reg %in% c("NorthernTunisia", "SouthernChile") ~ "cooler",
      reg %in% c("CentralTunisia", "CentralChile") ~ "hotter"
    )
  ) %>%
  mutate_if(is.factor, as.character) %>%
  mutate(reg = factor(reg, levels = c("CentralChile", "SouthernChile", "NorthernTunisia", "CentralTunisia"))) %>%
  mutate(
    S2.1c1 = case_when(str_detect(S2.1calt1, "unpredictable") | str_detect(S2.1calt1, "increased") ~ TRUE, T ~ FALSE),
    S2.1d1 = case_when(str_detect(S2.1dalt1, "unpredictable") | str_detect(S2.1dalt1, "increased") ~ TRUE, T ~ FALSE)
  )

set.seed(101)


# Time proximity
df_raw <- df_raw %>%
  mutate_at(
    c("S2.2b09", "S2.2b10", "S2.2b11", "S2.2b12", "S2.2b13", "S2.2b14", "S2.2b15", "S2.2b16", "S2.2b17", "S2.2b18", "S2.2b19"),
    function(x) case_when(is.na(x) ~ 0L, T ~ x)
  ) %>%
  mutate(
    S5.12 = case_when(
      S5.12 %in% c("1", "2") ~ 0,
      S5.12 %in% c("3", "4", "5", "6") ~ 1
    ),
    S2.2c_frequency = S2.2b09 + S2.2b10 + S2.2b11 + S2.2b12 + S2.2b13 + S2.2b14 + S2.2b15 + S2.2b16 + S2.2b17 + S2.2b18 + S2.2b19
  ) %>%
  mutate_at(c("S2.2c", "S2.3c", "S2.4c", "S2.5c", "S2.6c"), function(x) {
    case_when(is.na(x) ~ 0L, T ~ x)
  })
for (varia in c("S2.2b09", "S2.2b10", "S2.2b11", "S2.2b12", "S2.2b13", "S2.2b14", "S2.2b15", "S2.2b16", "S2.2b17", "S2.2b18", "S2.2b19")) {
  df_raw[[varia]] <- case_when(df_raw[[varia]] == 1 ~ as.numeric(stri_sub(varia, -2, -1)), T ~ 8)
}
df_raw <- df_raw %>% mutate(
  S2.2c_proximity = pmax(S2.2b09, S2.2b10, S2.2b11, S2.2b12, S2.2b13, S2.2b14, S2.2b15, S2.2b16, S2.2b17, S2.2b18, S2.2b19),
  S2.2c_frequency = as.numeric(S2.2c_frequency)
)
df_raw <- df_raw %>%
  mutate_at(
    c("S2.5b09", "S2.5b10", "S2.5b11", "S2.5b12", "S2.5b13", "S2.5b14", "S2.5b15", "S2.5b16", "S2.5b17", "S2.5b18", "S2.5b19"),
    function(x) case_when(is.na(x) ~ 0L, T ~ x)
  ) %>%
  mutate(S2.5c_frequency = S2.5b09 + S2.5b10 + S2.5b11 + S2.5b12 + S2.5b13 + S2.5b14 + S2.5b15 + S2.5b16 + S2.5b17 + S2.5b18 + S2.5b19)

for (varia in c("S2.5b09", "S2.5b10", "S2.5b11", "S2.5b12", "S2.5b13", "S2.5b14", "S2.5b15", "S2.5b16", "S2.5b17", "S2.5b18", "S2.5b19")) {
  df_raw[[varia]] <- case_when(df_raw[[varia]] == 1 ~ as.numeric(stri_sub(varia, -2, -1)), T ~ 8)
}
df_raw <- df_raw %>% mutate(
  S2.5c_proximity = pmax(S2.5b09, S2.5b10, S2.5b11, S2.5b12, S2.5b13, S2.5b14, S2.5b15, S2.5b16, S2.5b17, S2.5b18, S2.5b19),
  S2.5c_frequency = as.numeric(S2.5c_frequency)
)

df_raw <- df_raw %>%
  mutate_at(
    c("S2.6b09", "S2.6b10", "S2.6b11", "S2.6b12", "S2.6b13", "S2.6b14", "S2.6b15", "S2.6b16", "S2.6b17", "S2.6b18", "S2.6b19"),
    function(x) case_when(is.na(x) ~ 0L, T ~ x)
  ) %>%
  mutate(S2.6c_frequency = S2.6b09 + S2.6b10 + S2.6b11 + S2.6b12 + S2.6b13 + S2.6b14 + S2.6b15 + S2.6b16 + S2.6b17 + S2.6b18 + S2.6b19)

for (varia in c("S2.6b09", "S2.6b10", "S2.6b11", "S2.6b12", "S2.6b13", "S2.6b14", "S2.6b15", "S2.6b16", "S2.6b17", "S2.6b18", "S2.6b19")) {
  df_raw[[varia]] <- case_when(df_raw[[varia]] == 1 ~ as.numeric(stri_sub(varia, -2, -1)), T ~ 8)
}
df_raw <- df_raw %>% mutate(
  S2.6c_proximity = pmax(S2.6b09, S2.6b10, S2.6b11, S2.6b12, S2.6b13, S2.6b14, S2.6b15, S2.6b16, S2.6b17, S2.6b18, S2.6b19),
  S2.6c_frequency = as.numeric(S2.6c_frequency)
)

df_raw <- df_raw %>%
  mutate_at(
    c("S2.4b09", "S2.4b10", "S2.4b11", "S2.4b12", "S2.4b13", "S2.4b14", "S2.4b15", "S2.4b16", "S2.4b17", "S2.4b18", "S2.4b19"),
    function(x) case_when(is.na(x) ~ 0L, T ~ x)
  ) %>%
  mutate(S2.4c_frequency = S2.4b09 + S2.4b10 + S2.4b11 + S2.4b12 + S2.4b13 + S2.4b14 + S2.4b15 + S2.4b16 + S2.4b17 + S2.4b18 + S2.4b19)

for (varia in c("S2.4b09", "S2.4b10", "S2.4b11", "S2.4b12", "S2.4b13", "S2.4b14", "S2.4b15", "S2.4b16", "S2.4b17", "S2.4b18", "S2.4b19")) {
  df_raw[[varia]] <- case_when(df_raw[[varia]] == 1 ~ as.numeric(stri_sub(varia, -2, -1)), T ~ 8)
}
df_raw <- df_raw %>% dplyr::mutate(
  S2.4c_proximity = pmax(S2.4b09, S2.4b10, S2.4b11, S2.4b12, S2.4b13, S2.4b14, S2.4b15, S2.4b16, S2.4b17, S2.4b18, S2.4b19),
  S2.4c_frequency = as.numeric(S2.4c_frequency)
)

df_raw <- df_raw %>%
  mutate_at(
    c("S2.3b09", "S2.3b10", "S2.3b11", "S2.3b12", "S2.3b13", "S2.3b14", "S2.3b15", "S2.3b16", "S2.3b17", "S2.3b18", "S2.3b19"),
    function(x) case_when(is.na(x) ~ 0L, T ~ x)
  ) %>%
  mutate(S2.3c_frequency = S2.3b09 + S2.3b10 + S2.3b11 + S2.3b12 + S2.3b13 + S2.3b14 + S2.3b15 + S2.3b16 + S2.3b17 + S2.3b18 + S2.3b19)

for (varia in c("S2.3b09", "S2.3b10", "S2.3b11", "S2.3b12", "S2.3b13", "S2.3b14", "S2.3b15", "S2.3b16", "S2.3b17", "S2.3b18", "S2.3b19")) {
  df_raw[[varia]] <- case_when(df_raw[[varia]] == 1 ~ as.numeric(stri_sub(varia, -2, -1)), T ~ 8)
}
df_raw <- df_raw %>% dplyr::mutate(
  S2.3c_proximity = pmax(S2.3b09, S2.3b10, S2.3b11, S2.3b12, S2.3b13, S2.3b14, S2.3b15, S2.3b16, S2.3b17, S2.3b18, S2.3b19),
  S2.3c_frequency = as.numeric(S2.3c_frequency)
)


vars <- c("Farmer.", "Regions", "RegionsDetail", "Farmer.ID")
df <- df_raw %>%
  select(-vars) %>%
  select(-contains("S6"), -"S8.1a", -"S8.10b", -"S4.6not") %>%
  select(-contains("S8.12"), "S8.6e", -"S8.2b", -"S2.1aalt1", -"S4.6")

# change wrong coding
df$S4.1a[df$S4.1a == "6"] <- 3
df$S4.1b[df$S4.1b == "6"] <- 3
df$S4.1c[df$S4.1c == "6"] <- 3
df$S4.2a[df$S4.2a == "6"] <- 3
df$S4.2b[df$S4.2b == "6"] <- 3
df$S4.2d[df$S4.2d == "6"] <- 1
df$S4.2e[df$S4.2e == "6"] <- 1
df$S3.1b[df$S3.1b == 0] <- 1
# df$S2.5c[df$S2.5c == 0] <- 1
df$S2.8[df$S2.8 == 0] <- 1
df$S7.1[df$S7.1 == "N/A"] <- NA
df$S1.2a[df$S1.2a == "N/A"] <- NA
df[df == "N/A"] <- NA
df$S8.6c <- !is.na(df$S8.6c2)
df$S5.5n[is.na(df$S5.5n)] <- "NA"
df <- df %>% mutate_if(is.factor, as.character)
Mode <- function(x) {
  ux <- unique(x)
  ux[which.max(tabulate(match(x, ux)))]
}
for (vars in colnames(df)[!(colnames(df) %in% c("F5", "T5", "A5", "S4.1a"))]) {
  if (length(unique(df[[vars]])) < 4) {
    df[[vars]] <- as.character(df[[vars]])
  }
  if (sum(is.na(df[[vars]])) > 80) {
    df[[vars]] <- NULL
  }
  if (is.numeric(df[[vars]])) {
    df[[vars]][is.na(df[[vars]])] <- Mode(df[[vars]])
  }
  if (sum(is.na(df[[vars]])) < 10 & is.character(df[[vars]])) {
    df[[vars]][is.na(df[[vars]])] <- Mode(df[[vars]])
  }
  if (sum(is.na(df[[vars]])) > 10 & is.character(df[[vars]])) {
    df[[vars]][is.na(df[[vars]])] <- "NA"
  }
}

df <- df %>%
  mutate(
    S5.12 = case_when(
      S5.12 %in% c("1") ~ "TRUE",
      T ~ "FALSE"
    ),
    S3.3_low = case_when(
      S3.3 %in% c("1", "2") ~ "FALSE",
      S3.3 %in% c("3", "4", "5", "6") ~ "TRUE"
    ),
    S3.3 = case_when(
      S3.3 %in% c("1", "2", "3", "4") ~ "FALSE",
      S3.3 %in% c("4", "5", "6") ~ "TRUE"
    ),
  )
model_df <- df %>%
  mutate_at(
    c("A5", "T5", "F5", "S5.12", "S3.3"),
    function(x) {
      relevel(as.factor(x), ref = "FALSE")
    }
  ) %>%
  mutate(
    S1.3a = S1.3a == "2", S1.3b = S1.3b == "1",
    S1.3c = S1.3c == "2", S1.3d = S1.3d == "1", S1.3e = S1.3e == "1",
    S1.3f = S1.3f == "2",
    S2.7 = relevel(as.factor(S2.7 == "1"), ref = "FALSE"),
    S2.8 = relevel(as.factor(S2.8 == "1"), ref = "FALSE"),
    S3.5 = relevel(as.factor(S3.5), ref = "3"),
    S5.4 = relevel(as.factor(S5.4 == "YES"), ref = "FALSE"),
    S5.15 = relevel(as.factor(S5.15a == 1 | S5.15b == 1 | S5.15c == 5), ref = "FALSE"),
    S5.10 = relevel(as.factor(case_when(S5.10 == "I don’t know" ~ "not_know", T ~ S5.10)), ref = "NO"),
    S5.9 = relevel(as.factor(S5.9 == "TRUE"), ref = "FALSE"),
    S5.14 = relevel(as.factor(S5.14aa == 1 | S5.14ab == 1 | S5.14ac == 1 | S5.14ad == 1), ref = "FALSE"),
    S5.13d = relevel(as.factor(S5.13da >= 4 | S5.13db >= 4 | S5.13dc >= 4 | S5.13dd >= 4), ref = "FALSE"),
    S5.13 = relevel(as.factor(S5.13a >= 4 | S5.13b <= 2 | S5.13c >= 4), ref = "FALSE"),
    S5.13a = relevel(as.factor(S5.13a >= 4), ref = "FALSE"),
    S5.13b = relevel(as.factor(S5.13b >= 4), ref = "FALSE"),
    S5.13c = relevel(as.factor(S5.13c >= 4), ref = "FALSE"),
    S1.2a = relevel(as.factor(S1.2a %in% c("1", "2")), ref = "FALSE"),
    S2.2c_proximity = relevel(as.factor(S2.2c_proximity > 17), ref = "FALSE"),
    S2.2c_frequency = relevel(as.factor(S2.2c_frequency >= 3), ref = "FALSE"),
    S2.3c_proximity = relevel(as.factor(S2.3c_proximity > 17), ref = "FALSE"),
    S2.3c_frequency = relevel(as.factor(S2.3c_frequency >= 3), ref = "FALSE"),
    S2.5c_proximity = relevel(as.factor(S2.5c_proximity > 17), ref = "FALSE"),
    S2.5c_frequency = relevel(as.factor(S2.5c_frequency >= 3), ref = "FALSE"),
    S2.6c_proximity = relevel(as.factor(S2.6c_proximity > 17), ref = "FALSE"),
    S2.6c_frequency = relevel(as.factor(S2.6c_frequency >= 3), ref = "FALSE"),
    S2.4c_proximity = relevel(as.factor(S2.4c_proximity > 17), ref = "FALSE"),
    S8.1b = S8.1b > 50,
    S8.6e = (S8.6e != "NO")
  )

model_df <- lasso_df <- model_df %>%
  mutate(
    S3.1a = (S3.1a >= 4), S3.1b = S3.1b >= 4, S3.1c = S3.1c >= 4,
    S4.1a = case_when(S4.1a %in% c("4", "5") ~ "TRUE", T ~ "FALSE"),
    S4.2a = S4.2a >= 4, S4.2b = S4.2b >= 4,
    S4.2e = S4.2e >= 4, S4.2d = S4.2d >= 4, S4.1b = S4.1b >= 4, S4.1c = S4.1c >= 4,
    S4.8 = S4.8 >= 4,
    S4.4 = relevel(as.factor(S4.4 >= 4), ref = "TRUE"),
    S4.10 = S4.10 >= 4, S8.4a = S8.4a > 2,
    S2.2a = S2.2a == "YES", S2.3a = S2.3a == "YES", S2.4a = S2.4a == "YES",
    S2.5a = S2.5a == "YES", S2.6a = S2.6a == "YES", S5.15d = S5.15d > 4,
    S2.2 = relevel(factor(S2.2c >= 4 | S2.3c >= 4 | S2.4c >= 4 | S2.5c >= 4 | S2.6c >= 4), ref = "FALSE")
  )


model_df <- lasso_df <- model_df %>%
  mutate_at(
    c(
      "S5.11", "S4.9", "S5.17a", "S5.17b", "S5.17c", "S5.17d", "S3.4", "S1.2c", "S4.2c", "S5.14b",
      "S5.1a", "S5.1b"
    ),
    function(x) {
      relevel(as.factor(x %in% c("4", "5")), ref = "FALSE")
    }
  ) %>%
  mutate_at(
    c("S1.1e", "S1.1c", "S1.1a", "S1.1d"),
    function(x) {
      relevel(as.factor(as.character(x > 4)), ref = "FALSE")
    }
  ) %>%
  mutate(S8.1b = relevel(as.factor(S8.1b), ref = "FALSE")) %>%
  mutate(S4.4 = relevel(as.factor(S4.4), ref = "FALSE")) %>%
  mutate_at(
    paste0("S7.2", c("a", "b", "c", "d", "e", "f", "g", "h", "i", "j", "k")),
    function(x) {
      relevel(as.factor(as.character(x >= 6)), ref = "FALSE")
    }
  )

get_varimp <- function(model) {
  data.frame(varimp(model)) %>%
    mutate(reduction = reduction / sum(reduction)) %>%
    as_tibble() %>%
    filter(reduction != 0) %>%
    arrange(-reduction)
}

model_df <- model_df %>%
  mutate(
    AF3 = (A3 == "TRUE" & F3 == "TRUE"),
    AT3 = (A3 == "TRUE" & T3 == "TRUE"),
    TF3 = (T3 == "TRUE" & F3 == "TRUE"),
    ATF3 = (A3 == "TRUE" & F3 == "TRUE" & T3 == "TRUE"),
    AF5 = (A5 == "TRUE" & F5 == "TRUE"),
    AT5 = (A5 == "TRUE" & T5 == "TRUE"),
    TF5 = (T5 == "TRUE" & F5 == "TRUE"),
    ATF5 = (A5 == "TRUE" & F5 == "TRUE" & T5 == "TRUE"),
    S8.10a = (S8.10a == 1),
    S8.1d = case_when(S8.1d >= 4 ~ "TRUE", T ~ "FALSE"),
    S8.3b = S8.3b > 10,
    S8.4b = S8.4b > 2,
    S8.6a = S8.6a > 7,
    S8.6b = case_when(S8.6b <= 2 ~ "FALSE", T ~ "TRUE"),
    S8.7a = S8.7a,
    S8.7b = S8.7b,
    S8.7c = S8.7c,
    S8.14 = S8.14 == 4,
    S8.11 = case_when(S8.11 == "W" ~ "W", S8.11 %in% c("R", "RW") ~ "R", T ~ "rest"),
    S8.11_well = case_when(S8.11 == "W"~ 'TRUE', T ~ 'FALSE'),
    S8.11_river = case_when(S8.11 == "R"~ 'TRUE', T ~ 'FALSE'),
    S4.5a = S4.5a >= 4,
    S4.5b = S4.5b > 2,
    S8.13_low = S8.13 <= 2,
    S8.13 = S8.13 >= 4,
    S8.2balternative = S8.2balternative == "FAMALL"
  ) %>%
  mutate(
    S2.2c_no = case_when(S2.2c == 0 ~ 4, T ~ 3),
    S2.3c_no = case_when(S2.3c == 0 ~ 4, T ~ 3),
    S2.4c_no = case_when(S2.4c == 0 ~ 4, T ~ 3),
    S2.5c_no = case_when(S2.5c == 0 ~ 4, T ~ 3),
    S2.6c_no = case_when(S2.6c == 0 ~ 4, T ~ 3),
    S5.10 = case_when(S5.10 == "YES" ~ "TRUE", T ~ "FALSE")
  ) %>%
  mutate_at(
    c(
      "S2.2c", "S2.3c", "S2.4c", "S2.5c", "S2.6c",
      "S2.2c_no", "S2.3c_no", "S2.4c_no", "S2.5c_no", "S2.6c_no",
      "S1.1b"
    ),
    function(x) {
      (x >= 4)
    }
  ) %>%
  mutate_at(
    c(
      "S2.2c", "S2.3c", "S2.4c", "S2.5c", "S2.6c",
      "S2.2c_no", "S2.3c_no", "S2.4c_no", "S2.5c_no", "S2.6c_no",
      "S1.1b",
      "S4.1a", "S4.1b", "S4.1c", "S4.2a", "S4.2b", "S4.2d", "S4.2e",
      "S1.3a", "S1.3b", "S1.3c", "S4.5b", "S4.8", "S4.10", "S5.7",
      "S5.8","S8.11_well", "S8.11_river", "S3.3_low", "S8.1d", "S8.2a2"
    ),
    function(x) {
      relevel(as.factor(as.character(x)),
        ref = "FALSE"
      )
    }
  )

measures <- c("A5", "T5", "F5", "S5.12", "S5.9", "S5.8", "S5.4")
resilience <- c("S8.13", "S8.13_low", "S4.5b")
vul_now <- c("S2.2c", "S2.4c", "S2.5c", "S2.6c", "S2.2")
special_vul <- c("S2.2a", "S2.3a", "S2.4a", "S2.5a", "S2.6a", "S2.2aa")
temperature <- c("S2.1a1", "S2.1b3", "S2.1c1", "S2.1d1")
vul_future <- c("S4.2d", "S4.2e")
past_measures <- c("A3", "F3", "S3.4", "T3")
vul_outcomes <- c(
  "S2.2c", "S2.3c", "S2.4c", "S2.5c", "S2.6c", "S2.2c_no",
  "S2.3c_no", "S2.4c_no", "S2.5c_no", "S2.6c_no"
)
group_outcomes <- c(vul_now, past_measures, measures, resilience, "S3.4", "S3.1b", "S4.1b", "S4.2d", "S4.2e")

model_df <- model_df %>%
  mutate_at(unique(c(vul_outcomes, group_outcomes)), function(x) {
    relevel(as.factor(x), ref = "FALSE")
  }) %>%
  mutate_at(
    colnames(df)[str_detect(colnames(df), "S1.8|S1.9")],
    function(x) {
      (x >= 4)
    }
  )

group_df <- data.frame(group = "Biophysical asset group", index = 1, col_names = c("A3", "T3", "F3", "S8.11_river", "S8.11_well", "S8.6a", "S8.6e", "S8.6c", "S8.6b")) %>%
  rbind(data.frame(group = "Natural asset group", index = 2, col_names = c("reg"))) %>%
  rbind(data.frame(group = "Economic asset group", index = 3, col_names = c(
    "S3.3","S3.3_low", "S8.4b", "S8.13", "S8.13_low",
    "S8.4a", "S8.14"
  ))) %>%
  rbind(data.frame(group = "Human asset group", index = 4, col_names = c(
    "S8.1b", "S8.1c", "S8.1d", "S8.2a2",
    "S8.2balternative", "S8.3b", "S1.3a", "S1.3b", "S1.3d"
  ))) %>%
  rbind(data.frame(group = "Social asset group", index = 5, col_names = c(
    paste0("S1.8", c("a", "b", "c", "d", "e", "f", "g", "h", "i", "j")),
    paste0("S1.9", c("a", "b", "c", "d", "e", "f", "g", "h", "i", "j")),
    "S5.17a", "S5.17b", "S5.17c", "S5.17d"
  ))) %>%
  rbind(data.frame(group = "Climate experience group", index = 6, col_names = c("S2.1a1", "S2.1b3", "S2.1c1", "S2.1d1"))) %>%
  rbind(data.frame(group = "Vulnerability", index = 7, col_names = c(
    "S2.2c", "S2.3c", "S2.4c", "S2.5c", "S2.6c",
    "S2.2c_no", "S2.3c_no", "S2.4c_no", "S2.5c_no", "S2.6c_no"
  ))) %>%
  rbind(data.frame(group = "Goals group", index = 8, col_names = c(
    "S1.1b", "S1.1c", "S1.1d", "S1.1e"
  ))) %>%
  rbind(data.frame(group = "Harm group", index = 9, col_names = c(
    "S1.2a", "S1.2c", "S1.3f", "S3.1b", "S3.1c"
  ))) %>%
  rbind(data.frame(group = "Perception group", index = 10, col_names = c("S1.2c"))) %>%
  rbind(data.frame(group = "Temporal proximity group", index = 11, col_names = c(
   "S2.2c_proximity", "S2.3c_proximity", "S2.4c_proximity", "S2.5c_proximity",
   "S2.6c_proximity"
  ))) %>%
  rbind(data.frame(group = "Spatial group", index = 12, col_names = c(
   "S2.7", "S2.8", "S3.1a"
  ))) %>%
  rbind(data.frame(group = "Efficacy group", index = 13, col_names = c("S3.4"))) %>%
  rbind(data.frame(group = "Norms group", index = 14, col_names = c(
    "S3.5"
  ))) %>%
  mutate(col_names = as.character(col_names)) 

past_outcome_df <- data.frame(group = 'past outcome', index = 101, col_names = c(vul_now, 'S3.4'))

# Data manipulation and cleaning start

# Analysis

# Data for table A start
model_df %>% 
  select(all_of(vul_outcomes), reg) %>%
  gather('vulnerability', 'vul_value', - reg) %>%
  group_by(reg, vulnerability, vul_value) %>%
  tally() %>%
  ungroup() %>%
  group_by(reg, vulnerability) %>%
  mutate(n = n/sum(n)) %>%
  filter(vul_value == 'TRUE') %>%
  write.xlsx(paste0('05_Publikation/vul_efficacy/data/1_1/percentage_reg.xlsx'))

model_df %>% 
  select(all_of(vul_outcomes), Country) %>%
  gather('vulnerability', 'vul_value', - Country) %>%
  group_by(Country, vulnerability, vul_value) %>%
  tally() %>%
  ungroup() %>%
  group_by(Country, vulnerability) %>%
  mutate(n = n/sum(n)) %>%
  filter(vul_value == 'TRUE') %>%
  write.xlsx(paste0('05_Publikation/vul_efficacy/data/1_1/percentage_chile_tunisia.xlsx'))

model_df %>% 
  select(all_of(vul_outcomes)) %>%
  gather('vulnerability', 'vul_value') %>%
  group_by(vulnerability, vul_value) %>%
  tally() %>%
  ungroup() %>%
  group_by(vulnerability) %>%
  mutate(n = n/sum(n)) %>%
  filter(vul_value == 'TRUE') %>%
  write.xlsx(paste0('05_Publikation/vul_efficacy/data/1_1/percentage_all.xlsx'))
  
# data for table A end

# cumulative hazard scale coding variables
model_df <- model_df %>%
  mutate(S2.2c_sum = (S2.3c=='TRUE')+(S2.4c=='TRUE')+(S2.5c=='TRUE')+(S2.6c=='TRUE'),
         S2.2c_no_sum = (S2.3c_no=='TRUE')+(S2.4c_no=='TRUE')+(S2.5c_no=='TRUE')+(S2.6c_no=='TRUE'),
         S2.3c_sum = (S2.2c=='TRUE')+(S2.4c=='TRUE')+(S2.5c=='TRUE')+(S2.6c=='TRUE'),
         S2.3c_no_sum = (S2.2c_no=='TRUE')+(S2.4c_no=='TRUE')+(S2.5c_no=='TRUE')+(S2.6c_no=='TRUE'),
         S2.4c_sum = (S2.2c=='TRUE')+(S2.3c=='TRUE')+(S2.5c=='TRUE')+(S2.6c=='TRUE'),
         S2.4c_no_sum = (S2.2c_no=='TRUE')+(S2.3c_no=='TRUE')+(S2.5c_no=='TRUE')+(S2.6c_no=='TRUE'),
         S2.5c_sum = (S2.2c=='TRUE')+(S2.3c=='TRUE')+(S2.4c=='TRUE')+(S2.6c=='TRUE'),
         S2.5c_no_sum = (S2.2c_no=='TRUE')+(S2.3c_no=='TRUE')+(S2.4c_no=='TRUE')+(S2.6c_no=='TRUE'),
         S2.6c_sum = (S2.2c=='TRUE')+(S2.3c=='TRUE')+(S2.4c=='TRUE')+(S2.5c=='TRUE'),
         S2.6c_no_sum = (S2.2c_no=='TRUE')+(S2.3c_no=='TRUE')+(S2.4c_no=='TRUE')+(S2.5c_no=='TRUE'))

odds_df <- data.frame(type =NULL,
                      outcome = NULL)
# Table B2 start
for(outcome in vul_outcomes){
  formula <- paste0(outcome, '~reg+S8.1b+S8.1c+S8.1d+S8.11_river+S8.11_well')
  odds_df <- odds_df %>%
    rbind(
      glm(formula = formula, data = model_df, binomial('logit')) %>%
        odds.ratio() %>% as.data.frame() %>% rownames_to_column() %>% 
        mutate_if(is.numeric, function(x){round(x,3)}) %>%
        mutate(type = 'main', outcome = outcome)
    )
}
write.xlsx(odds_df, paste0('05_Publikation/vul_efficacy/data/1_3/odds_sociodemo.xlsx'))
odds_df <- data.frame(pred =NULL, Country=NULL,
                      outcome = NULL)
# Table B3 end

# Odds ratios hazard scale vs vulnerability/resilience
# Table 2 start
for(region in c('Tunisia', 'Chile', '', unique(model_df$reg))){
  if(region != '' & region %in% c('Tunisia', 'Chile')){
    temp_df <- model_df %>% filter(Country == region)
  } else if(region %in% unique(model_df$reg)){
    temp_df <- model_df %>% filter(reg == region)
  } else {temp_df <- model_df}
  for(outcome in vul_outcomes){
    formula <- paste0(outcome, '~S2.1a1+S2.1b3+S2.1c1+S2.1d1')
    odds_df <- odds_df %>%
      rbind(
  glm(formula = formula, data = temp_df, binomial('logit')) %>%
    odds.ratio() %>% as.data.frame() %>% rownames_to_column() %>% 
    mutate_if(is.numeric, function(x){round(x,3)}) %>%
    mutate(Region = region, outcome = outcome)
      )
    vul_predictors <- vul_outcomes[str_sub(vul_outcomes,1,5) != str_sub(outcome,1,5)]
    if(str_detect(outcome, '_no')){
      vul_predictors <- vul_predictors[str_detect(vul_predictors, '_no')]
    } else { vul_predictors <- vul_predictors[!str_detect(vul_predictors, '_no')]}
    vul_predictors <- paste0(vul_predictors, collapse = '+')
    formula <- paste0(outcome,'~', vul_predictors)
    odds_df <- odds_df %>%
      rbind(
        glm(formula = formula, data = temp_df, binomial('logit')) %>%
          odds.ratio() %>% as.data.frame() %>% rownames_to_column() %>% 
          mutate_if(is.numeric, function(x){round(x,3)}) %>%
          mutate(Region = region, outcome = outcome)
      )
    formula <- paste0(outcome, '~',paste0(outcome, '_sum'))
    odds_df <- odds_df %>% 
     rbind(
        glm(formula = formula, data = temp_df, binomial('logit')) %>%
          odds.ratio() %>% as.data.frame() %>% rownames_to_column() %>% 
          mutate_if(is.numeric, function(x){round(x,3)}) %>%
          mutate(Region = region, outcome = outcome)
      )
  }
}
write.xlsx(odds_df, paste0('05_Publikation/vul_efficacy/data/1_3/odds.xlsx'))
# table 2 end 

## additional visualization of table 2
odds_df %>%
  filter(Region %in% c('Chile', 'Tunisia')) %>%
  mutate(upper = `97.5 %`, lower = `2.5 %`,
         group = case_when(str_detect(outcome, '_')~'No vulnerability', T~ 'High vulnerability'),
         vulnerability = str_replace_all(outcome, '_.*', '')) %>%
  mutate(weather = case_when(str_detect(rowname, 'S2.1a1') ~ 'Increasing temperature', T ~ 'rowname'),
   weather = case_when(str_detect(rowname, 'S2.1b3') ~ 'Decreasing rainfall', T ~ weather),
   weather = case_when(str_detect(rowname, 'S2.1c1') ~ 'Increasing drought', T ~ weather),
   weather = case_when(str_detect(rowname, 'S2.1d1') ~ 'Increasing extreme weather', T ~ weather),
   weather = factor(weather, levels =c('Increasing temperature', 'Decreasing rainfall',
                                       'Increasing drought', 'Increasing extreme weather')),
   vulnerability = case_when(vulnerability == 'S2.2c'~ 'Summer temp \nvulnerability',
                             vulnerability == 'S2.3c'~ 'Winter temp \nvulnerability',
                             vulnerability == 'S2.4c'~ 'Percipitation \nvulnerability',
                             vulnerability == 'S2.5c'~ 'Drought \nvulnerability',
                             vulnerability == 'S2.6c'~ 'Extreme weather \nvulnerability')) %>%
  filter(!is.na(weather)) %>%
  ggplot(aes(x = weather, ymin=log(lower), ymax=log(upper), y = log(OR), color = group, fill = group)) +
  geom_errorbar(position=position_dodge(width=0.9), width = 0.6) + 
  geom_point(position=position_dodge(width=0.9), shape=21, size=1.5) +
  geom_hline(yintercept = 0, linetype='dashed', size = 0.1,
             col = 'black') + coord_flip() +
  theme_bw(#base_family = 'Arial',
    base_size = 10) + ylim(c(-5,5)) + facet_grid(Region ~ vulnerability ) + xlab('') +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
        #axis.text.x.bottom = element_text(angle = 45, vjust = 0.5, hjust=1),
        legend.title = element_blank(), legend.position = 'bottom') +
  scale_fill_manual(values = c('#B2114E', '#003366'))+
  scale_color_manual(values = c('#B2114E', '#003366')) + ylab('Odds ratios (log)')
ggsave('05_Publikation/vul_efficacy/data/1_3/odds_experience.png', width = 7, height = 5, dpi = 600)
ggsave('05_Publikation/vul_efficacy/data/1_3/odds_experience.pdf', width = 7, height = 5, dpi = 600)

# figure 3 start

plotdata <- model_df %>%
  select(contains('S2.2c'), contains('S2.3c'),contains('S2.4c'),
         contains('S2.5c'),contains('S2.6c')) %>%
  select(-contains('proximity'), -contains('frequency')) 
plotdata <- plotdata %>%
  gather(-contains('sum'),
         key = 'outcome',
         value = 'outcome_value') %>%
  gather(contains('sum'),
         key = 'sum',
         value = 'sum_value') %>%
  mutate(sum = str_replace_all(sum, '_sum', '')) %>%
  filter(sum == outcome) %>%
  group_by(outcome, outcome_value, sum_value) %>%
  tally() %>%
  ungroup() %>%
  group_by(outcome, sum_value) %>%
  mutate(Probability = n/sum(n)) %>%
  filter(outcome_value == 'TRUE') %>%
  mutate(vulnerability = case_when(str_detect(outcome, '_no') ~ 'Resilience', T ~ 'High vulnerability'),
         outcome = str_replace_all(outcome, '_no', ''),
         'Odds' = log(Probability/(1-Probability)),
         outcome = case_when(outcome == 'S2.2c'~ 'Summer temperature',
                             outcome == 'S2.3c'~ 'Winter temperature',
                             outcome == 'S2.4c'~ 'Percipitation',
                             outcome == 'S2.5c'~ 'Drought',
                             outcome == 'S2.6c'~ 'Extreme weather')) %>%
  select(-outcome_value, -n) 
plot_1 <- plotdata %>% 
  ggplot(aes(x = sum_value, y = Probability, color = outcome)) + 
  geom_point() + geom_line() + xlab('vulnerability index (left), resilience index (right)')+
  facet_wrap(~vulnerability)+ theme_bw(base_size = 14) + 
  scale_color_brewer(palette="Dark2") +
  theme(axis.title.x=element_blank(), legend.title=element_blank(),
        legend.position = 'top',legend.spacing.y = unit(0, 'cm'), legend.box.spacing = unit(0, "pt"))
plot_2 <- plotdata %>% 
  ggplot(aes_string(x = 'sum_value', y = 'Odds', color = 'outcome')) + 
  geom_point() + geom_line() + ylab('Odds (log)') + xlab('Vulnerability index                                               Resilience index')+
  facet_wrap(~vulnerability) + theme_bw(base_size = 14) + 
  theme(legend.title=element_blank(), legend.position = 'None') +
  scale_y_continuous(limits = c(-4, 4), breaks = c(-4.00, -2.00, 0, 2.00, 4.00), 
                     labels = c('-4.00', '-2.00', '0.00', '2.00', '4.00'))+ 
  scale_color_brewer(palette="Dark2") +
  theme(#axis.title.x=element_blank(), 
    legend.title=element_blank())
val_figure <- grid.arrange(plot_1, plot_2,
                           layout_matrix = rbind(c(1), c(2))) 
ggsave('05_Publikation/vul_efficacy/data/1_3/validation.png', val_figure, width = 9, height = 9, dpi = 600)

# figure 3 end

odds_df <- data.frame(pred =NULL, Country=NULL,
                      outcome = NULL, measure = NULL, measure_value = NULL)
for(region in c('Tunisia', 'Chile', 'Chile & Tunisia')){
  for(predictor in c('A3', 'T3', 'F3')){
    
  if(region != 'Chile & Tunisia'){
    temp_df <- model_df %>% filter(Country == region)
  } else {temp_df <- model_df}
  for(outcome in c('S2.2c', 'S2.3c', 'S2.4c', 'S2.5c', 'S2.6c', 'S2.2c_no', 
                   'S2.3c_no', 'S2.4c_no', 'S2.5c_no', 'S2.6c_no')){
    formula <- paste0(outcome, '~S3.4')
    odds_df <- odds_df %>% 
      rbind(
    glm_model <- glm(formula = formula, data = temp_df %>% filter(get(predictor) == 'TRUE'), binomial('logit')) %>%
      odds.ratio() %>% as.data.frame() %>% rownames_to_column() %>% 
      mutate_if(is.numeric, function(x){round(x,3)}) %>%
      slice(2) %>%
      mutate(Country = region, outcome = outcome, measure = predictor)
      )
  }
  }
}
write.xlsx(odds_df, paste0('05_Publikation/vul_efficacy/data/1_3/interactions.xlsx'))

plotdata <- model_df %>%
  select(S3.4, A3,T3,F3,all_of(vul_outcomes)) %>%
  gather('measure', 'measure_value', -S2.2c,-S2.3c,-S2.4c,-S2.5c,-S2.6c, -S3.4,
         -S2.2c_no,-S2.3c_no,-S2.4c_no,-S2.5c_no,-S2.6c_no) %>%
  filter(measure_value == 'TRUE')
plotdata %>% 
  gather(key = 'vulnerability',value = 'vulnerability_value', -S3.4,-measure,-measure_value) %>%
  group_by(vulnerability, measure, S3.4, vulnerability_value) %>% 
  tally() %>%
  ungroup() %>%
  group_by(vulnerability, measure, S3.4) %>%
  mutate(perc = n/sum(n)) %>%
  ungroup() %>%
  filter(vulnerability_value == 'TRUE') %>%
  left_join(odds_df %>% filter(Country == 'Chile & Tunisia'), by = c('vulnerability' = 'outcome', 'measure' = 'measure')) %>%
  mutate(vulnerability_type = str_replace_all(vulnerability, '_no', ''),
         direction = case_when(str_detect(vulnerability, '_no')~ 'No vulnerability', T~'High vulnerability'),
         vulnerability_type = case_when(vulnerability_type == 'S2.2c' ~ 'Summer temperature',
                                        vulnerability_type == 'S2.3c' ~ 'Winter temperature',
                                        vulnerability_type == 'S2.4c' ~ 'Percipitation',
                                        vulnerability_type == 'S2.5c' ~ 'Drought',
                                        vulnerability_type == 'S2.6c' ~ 'Extreme weather'),
         vulnerability_type = factor(vulnerability_type, 
                                        levels = c('Summer temperature','Winter temperature', 
                                                   'Percipitation', 'Drought', 'Extreme weather')),
         measure = case_when(measure == 'A3' ~ 'Agronomic', measure == 'T3' ~ 'Technological', 
                             measure == 'F3' ~ 'Economic'),
         Efficacy = case_when(S3.4 == 'TRUE' ~'High', T ~ 'Low'),
         p = case_when(Efficacy == 'High' | p>0.05 ~ NA_real_, T ~ perc)
  ) %>%
  
  ggplot(aes(x = measure, y = perc, color = Efficacy, fill = Efficacy)) +
  geom_bar(stat = 'identity', position = position_dodge(), width = 0.6) +# coord_flip() +
  theme_bw(base_size = 10) + facet_grid(direction ~ vulnerability_type) + xlab('') +
  geom_text(aes(x= measure, y = p, 
                label = sprintf('*')), size = 4, position = position_identity(), hjust=-0.1, vjust=0.3) +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1),
        axis.text.x.bottom = element_text(angle = 45, vjust = 1, hjust=1), legend.position = 'bottom') +
  scale_fill_manual(values = c('#B2114E', '#003366'))+
  scale_color_manual(values = c('#B2114E', '#003366')) + ylab('Probaility high/no vulnerability')
ggsave('05_Publikation/vul_efficacy/data/1_3/efficacy_figure.png', width = 7, height = 5, dpi = 600)
  

# predictive modeling for all vulnerability/resilience outcomes
## this loop estimates the models on the training data evaluates them,
## computes variable importances and odds ratios. 
## The results are depicted in tables 1, D and E.
big_pred_df <- data.frame()
big_varimp_mb <- data.frame()
big_varimp_sgb <- data.frame()
big_new_odds <- data.frame()
big_varimp_int <- data.frame()
big_varimp_int_exp <- data.frame()
tic()
for(pred_vars in c('all', 'no_vul')){
for(region in c('', 'Tunisia', 'Chile')){
  if(region %in% unique(model_df$Country)){vul_df <- model_df %>% filter(Country %in% region)}
  else {vul_df <- model_df}
  for(outcome in vul_outcomes){
    index_df <- group_df %>%
      filter(col_names != outcome & col_names != substring(outcome,1,5),
             substring(col_names, 1,5) != substring(outcome,1,5)) %>%
      mutate(sgl_name = col_names)
    if(pred_vars == 'no_vul'){
      index_df <- index_df %>%
        filter(!str_detect(col_names, 'S2.2c|S2.3c|S2.4c|S2.5c|S2.6c'))}
    if(pred_vars == 'all'){
      index_df <- index_df %>%
        rbind(data.frame(group = "vul_sum", index = 14, col_names = c(
          paste0(outcome, '_sum')), sgl_name = paste0(outcome, '_sum'))) %>%
        mutate(col_names = as.character(col_names), sgl_name = as.character(sgl_name)) 
    }
    if(region == 'Tunisia'){
      index_df <- index_df %>%
        filter(col_names != 'S8.11_river')
    }
    # statistical model
    # varimp 
    predictors <- index_df$col_names[index_df$col_names != outcome]
    mb_formula <- paste0(paste0('bols(', predictors, ')'),collapse = '+')
    mb_formula <- as.formula(paste0(outcome, '~', mb_formula))
    sgb0.5_formula <-  prepare_sgb(alpha = 0.5, index_df = index_df, outcome_name = outcome)
    sgb0.5_formula <- paste0(outcome, '~', sgb0.5_formula) %>% as.formula()
    mb_model <- mboost(formula = mb_formula, data = vul_df, family = Binomial(link = 'logit'),
                       control = boost_control(mstop = 4000, nu = 0.1))
    
    sgb0.5_model <- mboost(formula = sgb0.5_formula, data = vul_df, family = Binomial(link = 'logit'),
                           control = boost_control(mstop = 4000, nu = 0.3))
    cl <- makeCluster(15)
    mb_model <- mb_model[mstop(cvrisk(mb_model, papply = myApply))]
    sgb0.5_model <- sgb0.5_model[mstop(cvrisk(sgb0.5_model, papply = myApply))]
    big_varimp_mb <- big_varimp_mb %>%
      rbind(
    get_varimp(mb_model) %>%
      mutate(outcome = outcome, Country = region, variables = pred_vars) %>% slice(1:15))
    big_varimp_sgb <- big_varimp_sgb %>%
      rbind(
        get_varimp(sgb0.5_model) %>%
          mutate(outcome = outcome, Country = region, variables = pred_vars) %>% slice(1:15))
    sgb0.5_model$coef() %>% lapply(function(x){x[-1]}) %>% bind_rows() %>% 
      summarize_all(function(x){exp(sum(x, na.rm = T))}) %>%
      write.xlsx(paste0('05_Publikation/vul_efficacy/data/predictions/',region,pred_vars,'_sgb_odds',
                        outcome, '.xlsx'))
    sgb_temp <- sgb0.5_model$coef() %>% lapply(function(x){mean(x[-1])}) %>% as.vector()
    data.frame(blearner = names(sgb_temp), variable = str_replace_all(names(sgb_temp), 'bols\\(|, df.*', '')) %>% 
      mutate(direction = sgb_temp %>% bind_rows() %>% c())  %>% 
      mutate(outcome = outcome, Country = region, variables = pred_vars) %>%
      write.xlsx(paste0('05_Publikation/vul_efficacy/data/predictions/',region,pred_vars,'_sgb_direction',
                        outcome, '.xlsx'))
    
    # prediction 
    train_index <- sample(1:dim(vul_df)[1], dim(vul_df)[1]*0.7)
    
    ## sgb
    
    sgb0.5_model_train <- mboost(formula = as.formula(sgb0.5_formula),
                                 family = Binomial(link ="logit"), data = vul_df[train_index,],
                                 control = boost_control(mstop = 20000, nu = 0.3))
    cv_folds_train <- cv(model.weights(sgb0.5_model_train), type = "kfold", B = 10)
    cv_sgb0.5_train <- cvrisk(sgb0.5_model_train, folds = cv_folds_train, papply = myApply)
    sgb0.5_model_train <- sgb0.5_model_train[mstop(cv_sgb0.5_train)]
    print('sgb')
    print(mstop(sgb0.5_model_train))
    ## mb 
    
    mb_model_train <- mboost(formula = as.formula(mb_formula),
                             family = Binomial(link ="logit"), data = vul_df[train_index,],
                             control = boost_control(mstop = 4000, nu = 0.1))
    cv_mb_model_train <- cvrisk(mb_model_train, folds = cv_folds_train, papply = myApply)
    mb_model_train <- mb_model_train[mstop(cv_mb_model_train)]
    print('mb')
    print(mstop(mb_model_train))
  
    # interactions 
    if(region == ''){
      get_interactions <- function(predictors_1, predictors_2){
        mb_formula_interact <- vector()
        for(var_1 in predictors_1){
          for(var_2 in predictors_2){
            if(var_2 != var_1){
              mb_formula_interact[paste0(var_1,var_2)] <- paste0('bols(', var_1,', by =', var_2, ', df = 1)')
            }
          }
        }
        return(mb_formula_interact)
      }
      mb_formula_interact <-
        get_interactions( 
          predictors[c(-4,-12)],c('S2.1a1', 'S2.1b3', 'S2.1c1', 'S2.1d1', 'S3.3',  'S8.1b','S8.1c', 'S8.11_well',
                       'S3.4','T3', 'F3', 'A3' , 'Country', 'reg', 'S8.14', 'S8.1d', 'S1.8c', 'S1.9c', 'S1.8j', 'S1.8j','S1.2c', 'S1.1c' 
                        )
          )
      #mb_formula_interact <- paste0(mb_formula_interact, get_interactions(vul_outcomes[vul_outcomes %in% c(outcome, paste0(outcome, '_no'))]))
      mb_formula_interact_exp <-
        c(mb_formula_interact, paste0('bols(', predictors, ',df=1)'))
      
      mb_formula_interact_exp <- paste0(mb_formula_interact_exp,collapse = '+')
      
      mb_interact_exp_train <- mboost(formula = as.formula(paste0(outcome, '~',mb_formula_interact_exp)),
                                      family = Binomial(link ="logit"), data = vul_df[train_index,],
                                      control = boost_control(mstop = 1000, nu = 0.1))
      cv_mb_interact_exp_train <- cvrisk(mb_interact_exp_train, folds = cv_folds_train, papply = myApply)
      mb_interact_exp_train <- mb_interact_exp_train[mstop(cv_mb_interact_exp_train)]
      
      mb_interact_exp <- mboost(formula = as.formula(paste0(outcome, '~',mb_formula_interact_exp)),
                                family = Binomial(link ="logit"), data = vul_df,
                                control = boost_control(mstop = 1000, nu = 0.1))
      cv_mb_interact_exp <- cvrisk(mb_interact_exp, papply = myApply)
      mb_interact_exp <- mb_interact_exp[mstop(cv_mb_interact_exp)]
      big_varimp_int_exp <- 
        big_varimp_int_exp %>%
        rbind(
      get_varimp(mb_interact_exp) %>% group_by(str_detect(variable, ',')) %>% mutate(n = n()) %>% ungroup() %>% mutate(n_max = max(n)) %>% slice(1:15) %>%  
        mutate(Country = region, outcome = outcome, variables = pred_vars)
        )
      # 2-step boosting for interactions
      mb_formula_interact <- paste0(mb_formula_interact, collapse = '+')
      int_df <- vul_df %>%
        mutate(int_outcome = predict(mb_model, type = 'class'),
               int_outcome = relevel(as.factor(int_outcome == get(outcome)), ref = 'FALSE'))
      mb_interact <- mboost(formula = as.formula(paste0('int_outcome', '~',mb_formula_interact)),
                                family = Binomial(link ="logit"), data = int_df,
                                control = boost_control(mstop = 1000, nu = 0.01))
      cv_mb_interact <- cvrisk(mb_interact, papply = myApply)
      mb_interact <- mb_interact[mstop(cv_mb_interact)]
      big_varimp_int <- 
        big_varimp_int %>%
        rbind(
          get_varimp(mb_interact) %>% mutate(n = n()) %>% slice(1:15) %>%  
            mutate(Country = region, outcome = outcome, variables = pred_vars)
        )
      int_df <- int_df[train_index,] %>% 
        mutate(int_outcome = predict(mb_model_train, type = 'class'),
               int_outcome = relevel(as.factor(int_outcome == get(outcome)), ref = 'FALSE'))
        
      mb_interact_train <- mboost(formula = as.formula(paste0('int_outcome', '~',mb_formula_interact)),
                                      family = Binomial(link ="logit"), data = int_df,
                                      control = boost_control(mstop = 1000, nu = 0.01))
      cv_mb_interact_train <- cvrisk(mb_interact_train, folds = cv_folds_train, papply = myApply)
      mb_interact_train <- mb_interact_exp_train[mstop(cv_mb_interact_train)]
      
    } else {mb_interact_train <- mb_model_train
    mb_interact_exp_train <- mb_model_train}
    # prediction:
    pred_df <- vul_df[-train_index,] %>%
      transmute(pred_sgb0.5 = predict(sgb0.5_model_train,vul_df[-train_index,], type = 'response'),
                pred_mb = predict(mb_model_train,vul_df[-train_index,], type = 'response'),
                pred_mb_link = predict(mb_model_train,vul_df[-train_index,], type = 'link'),
                pred_mb_int_link = predict(mb_interact_train,vul_df[-train_index,], type = 'link'),
                pred_mb_int = pred_mb_link+pred_mb_int_link,
                pred_mb_int = exp(2*pred_mb_int) / (1 + exp(2*pred_mb_int)),
                pred_mb_int_exp = predict(mb_interact_exp_train,vul_df[-train_index,], type = 'response'))
    pred_df$response <- vul_df[-train_index,][[outcome]]
    pred_df$outcome <- outcome
    pred_df %>% 
      mutate(Country = region, variables = pred_vars) %>%
    write.xlsx(paste0('05_Publikation/vul_efficacy/data/predictions/',region,pred_vars,'_', outcome,'pred_df.xlsx'))
    
    auc_df <- data.frame(
      auc_sgb0.5 = auc(response = vul_df[-train_index,][[outcome]],
                       predictor = pred_df$pred_sgb0.5),
      pred_mb = auc(response = vul_df[-train_index,][[outcome]],
                    predictor = pred_df$pred_mb),
      pred_mb_int = auc(response = vul_df[-train_index,][[outcome]],
                        predictor = pred_df$pred_mb_int),
      pred_mb_int_exp = auc(response = vul_df[-train_index,][[outcome]],
                            predictor = pred_df$pred_mb_int_exp),
      outcome = outcome, Country = region, variables = pred_vars)
    big_pred_df <- big_pred_df %>% 
      rbind(auc_df)
    write.xlsx(auc_df,  paste0('05_Publikation/vul_efficacy/data/1_2/',region,pred_vars, '_', outcome,'prediction.xlsx'))
    stopCluster(cl)  
    
    # resynthesis
    important_vars <- get_varimp(mb_model) %>% slice(1:15) %>%
      magrittr::extract2('variable') %>% as.character()
    new_vars <- important_vars
    if(length(new_vars) != 0){
    new_formula <- as.formula(paste0(outcome,'~',paste0(new_vars, collapse = '+')))
    
    big_new_odds <- big_new_odds %>%
      rbind(
    glm(formula = new_formula, data = vul_df, binomial('logit')) %>%
      odds.ratio() %>% 
      as.data.frame() %>% 
      mutate_all(function(x){round(x,3)}) %>% 
      rownames_to_column() %>%
      mutate(outcome = outcome, Country = region, variables = pred_vars)
      )
    }
  }
}
}
toc()

write.xlsx(big_pred_df,  paste0('05_Publikation/vul_efficacy/data/1_2_nice/auc_data.xlsx'))
write.xlsx(big_new_odds,  paste0('05_Publikation/vul_efficacy/data/1_2_nice/new_odds.xlsx'))
write.xlsx(big_varimp_sgb,  paste0('05_Publikation/vul_efficacy/data/1_2_nice/varimp_sgb.xlsx'))
write.xlsx(big_varimp_mb,  paste0('05_Publikation/vul_efficacy/data/1_2_nice/varimp_mb.xlsx'))
write.xlsx(big_varimp_int,  paste0('05_Publikation/vul_efficacy/data/1_2_nice/varimp_interaction.xlsx'))
write.xlsx(big_varimp_int_exp,  paste0('05_Publikation/vul_efficacy/data/1_2_nice/varimp_interaction_exp.xlsx'))

# group list
model_df %>%
  select(group_df$col_names) %>%
  gather('variable', 'category') %>%
  group_by(variable, category) %>% 
  tally() %>%
  left_join(group_df, by = c('variable' = 'col_names')) %>%
  filter(category != 'FALSE') %>%
  select(-index) %>%
  arrange(group) %>%
  mutate(short_names = variable) %>%
  clean_names() %>%
  write.xlsx(paste0('05_Publikation/vul_efficacy/data/method_data/variables_new.xlsx'))

# group importance
big_varimp_sgb %>% 
  filter(variables != 'all') %>%
  left_join(group_df, by = c('variable' = 'col_names')) %>%
  mutate(group = case_when(is.na(group)~ variable, T ~ group)) %>%
  mutate(group = dplyr::case_when(str_detect(group, 'S1.8a, S1.8b') ~ 'Social asset group',
                                     str_detect(group, 'S1.3a, S1.3b') ~ 'Human asset group',
                                     str_detect(group, 'A3, F3') ~ 'Biophysical asset group',
                                     str_detect(group, 'S2.1a1, S') ~ 'Climate hazard group',
                                     str_detect(group, 'S2.2c, S2.4c') ~ 'Vulnerability group',
                                     str_detect(group, 'S3.3, S3.3_low') ~ 'Economic asset group',
                                     str_detect(group, 'S1.1b, S1.1c') ~ 'Goals group',
                                     str_detect(group, 'S2.7, S2.8') ~ 'Spatial group',
                                     T ~ group)
  ) %>%
  group_by(outcome, group) %>%
  filter(reduction > 0.02) %>%
  summarize(perc = sum(reduction)) %>%
  ungroup() %>%
  group_by(outcome) %>%
  arrange(group) %>%
  View()

group_df %>%
  mutate('variable' = col_names) %>%
  select(-index) %>%
  clean_names() %>%
  write.xlsx('05_Publikation/vul_efficacy/data/method_data/variables.xlsx')

# ROC curves
auc_plot <- read.xlsx('05_Publikation/vul_efficacy/data/predictions/no_vul_S2.6c_nopred_df.xlsx') %>% mutate_at(c('pred_sgb0.5','pred_mb','pred_mb_link','pred_mb_int_link','pred_mb_int','pred_mb_int_exp'), as.numeric) %>%
 # bind_rows(read.xlsx('05_Publikation/vul_efficacy/data/predictions/no_vul_S2.6cpred_df.xlsx')) %>%
  bind_rows(read.xlsx('05_Publikation/vul_efficacy/data/predictions/no_vul_S2.5c_nopred_df.xlsx') %>% mutate_at(c('pred_sgb0.5','pred_mb','pred_mb_link','pred_mb_int_link','pred_mb_int','pred_mb_int_exp'), as.numeric)) %>%
 # bind_rows(read.xlsx('05_Publikation/vul_efficacy/data/predictions/no_vul_S2.5cpred_df.xlsx')) %>%
 # bind_rows(read.xlsx('05_Publikation/vul_efficacy/data/predictions/no_vul_S2.4cpred_df.xlsx')) %>%
  bind_rows(read.xlsx('05_Publikation/vul_efficacy/data/predictions/no_vul_S2.4c_nopred_df.xlsx') %>% mutate_at(c('pred_sgb0.5','pred_mb','pred_mb_link','pred_mb_int_link','pred_mb_int','pred_mb_int_exp'), as.numeric)) %>%
 # bind_rows(read.xlsx('05_Publikation/vul_efficacy/data/predictions/no_vul_S2.3cpred_df.xlsx')) %>%
  bind_rows(read.xlsx('05_Publikation/vul_efficacy/data/predictions/no_vul_S2.3c_nopred_df.xlsx') %>% mutate_at(c('pred_sgb0.5','pred_mb','pred_mb_link','pred_mb_int_link','pred_mb_int','pred_mb_int_exp'), as.numeric)) %>%
 # bind_rows(read.xlsx('05_Publikation/vul_efficacy/data/predictions/no_vul_S2.2cpred_df.xlsx')) %>%
  bind_rows(read.xlsx('05_Publikation/vul_efficacy/data/predictions/no_vul_S2.2c_nopred_df.xlsx') %>% mutate_at(c('pred_sgb0.5','pred_mb','pred_mb_link','pred_mb_int_link','pred_mb_int','pred_mb_int_exp'), as.numeric))
auc_plot <- auc_plot %>%
 select(-contains('link'),-Country, -variables) %>%
  rename('sgb' = 'pred_sgb0.5', 'mb' = 'pred_mb', 
         'mbh int' = 'pred_mb_int','mb int' = 'pred_mb_int_exp') %>%
  gather(value = 'pred', key = 'model', -response, -outcome) %>%
  # mutate(vulnerability = case_when(str_detect(outcome, '_no') ~ 'High', T ~ 'No'),
  #        outcome = str_replace_all(outcome, '_no', '')) %>% 
  mutate(model = factor(model, levels = c('mb','mbh int','sgb' , 'mb int')),
         pred = as.numeric(pred),
         outcome = case_when(str_detect(outcome, 'S2.2c') ~ 'Summer temperature',
                             str_detect(outcome, 'S2.3c') ~ 'Winter temperature',
                             str_detect(outcome, 'S2.4c') ~ 'Decreasing rainfall',
                             str_detect(outcome, 'S2.5c') ~ 'Drought',
                             str_detect(outcome, 'S2.6c') ~ 'Extreme weather'),
         outcome = factor(outcome, levels = c('Summer temperature','Winter temperature',
                                              'Decreasing rainfall' , 'Drought', 'Extreme weather')))
  auc_plot %>% 
  ggplot(aes(m = pred, d = response, color = model, linetype = model)) +
  geom_roc(labels = F, n.cuts = 0, size = 0.8, alpha = 2) + theme_bw(base_size = 9) + ylab("True positive fraction") +
  xlab('False positive fraction') + scale_color_brewer(palette =  'Dark2') +
  geom_abline(slope = 1, intercept = 0, linetype='dotted') + facet_grid(.~ outcome) +
  theme(legend.title=element_blank())
ggsave('05_Publikation/vul_efficacy/data/method_data/auc_all.png', width = 9, height = 5, dpi = 600)
big_pred_df %>%
  filter(variables == 'no_vul', Country == '', str_detect(outcome, 'no')) %>%
  summarize_at(colnames(big_pred_df)[1:4], function(x){round(mean(x),4)} )

# variable importance plots for interactions

varimp_fun <- function(outcome_var){
plot_1 <- 
    big_varimp_sgb %>% mutate(model = 'sgb') %>%
  rbind(big_varimp_mb %>% mutate(model = 'mb')) %>%
  filter(str_detect(outcome, outcome_var)) %>%
  filter(Country == '', variables == 'no_vul', str_detect(outcome,'no')) %>%
  mutate(variable = as.character(variable)) %>% 
  mutate(variable = dplyr::case_when(str_detect(variable, 'S1.8a, S1.8b') ~ 'Social asset group',
                              str_detect(variable, 'S1.3a, S1.3b') ~ 'Human asset group',
                              str_detect(variable, 'A3, F3') ~ 'Biophysical asset group',
                              str_detect(variable, 'S2.1a1, S') ~ 'Climate hazard group',
                              str_detect(variable, 'S2.2c, S2.4c') ~ 'Vulnerability group',
                              str_detect(variable, 'S3.3, S3.3_low') ~ 'Economic asset group',
                              str_detect(variable, 'S1.1b, S1.1c') ~ 'Goals group',
                              str_detect(variable, 'S2.7, S2.8') ~ 'Spatial group',
                              T ~ variable)
         ) %>% 
  clean_names() %>%
  #group_by(variable) %>%
  mutate(order =reduction) %>%
  arrange(order) %>%
  filter(reduction>0.01) %>%
  ungroup() %>%
  mutate(vulnerability = case_when(str_detect(outcome, '_no') ~ paste0('No ', names(vul_outcomes[vul_outcomes == outcome_var])),
                                   T~ paste0('High ', names(vul_outcomes[vul_outcomes == outcome_var])))) %>%
  ggplot(aes(x= reorder(variable, order), y = reduction, fill = model)) +
  geom_bar(position = position_stack(reverse = TRUE), stat = "identity") + coord_flip() +
  scale_fill_manual(values = c("#680cab", "#6d95cc")) +
  theme_bw(base_size=6) + theme(legend.position = "none") + xlab('')+ ylim(c(0,1))+
  ylab('Relative Importance') + facet_grid(.~model)
return(plot_1)


}
names(vul_outcomes) <- c('vulnerability summer temperature','vulnerability winter temperature',
                        'vulnerability decreasing rainfall','vulnerability drought',
                        'vulnerability extreme weather','vulnerability summer temperature',
                        'vulnerability winter temperature', 'vulnerability decreasing rainfall',
                        'vulnerability drought', 'vulnerability extreme weather')


plot_1 <- varimp_fun(outcome_var = vul_outcomes[1]) + ylab('Variable importance vulnerability summer temperature')
plot_2 <- varimp_fun(outcome_var = vul_outcomes[2])+ylab('Variable importance vulnerability winter temperature')
plot_3 <- varimp_fun(outcome_var = vul_outcomes[3])+ylab('Variable importance vulnerability decreasing rainfall')
plot_4 <- varimp_fun(outcome_var = vul_outcomes[4])+ylab('Variable importance vulnerability drought')
plot_5 <- varimp_fun(outcome_var = vul_outcomes[5])+ylab('Variable importance vulnerability extreme weather')
varimp_plot_1 <- grid.arrange(plot_1, plot_2,plot_3,plot_4,plot_5,layout_matrix = rbind(c(1,2, NA), c(3,4,5)))
ggsave(paste0('05_Publikation/vul_efficacy/data/method_data/varimp.png'), varimp_plot_1, width = 9, height = 6, dpi = 900)
# varimp interactions helper function
varimp_int_fun <- function(outcome_var){
int_plot <- big_varimp_int %>% mutate(method = '2-step') %>%
  rbind(
    big_varimp_int_exp %>% select(-n_max,-"str_detect(variable, \",\")") %>%
      mutate(method = 'parallel')
  ) %>%
  mutate(variable = as.character(variable)) %>%
  filter(str_detect(variable, ',')) %>%
  filter(str_detect(outcome, paste0(outcome_var, '_no'))) %>% 
  filter(Country == '', variables == 'no_vul') %>%
  clean_names() %>%
  mutate(variable = str_replace_all(variable, ', ', ',\n')) %>%
  group_by(variable) %>%
  mutate(order = sum(reduction)) %>%
  arrange(order) %>%
  filter(reduction>0.02) %>%
  ungroup() %>%
  mutate(vulnerability = names(vul_outcomes[vul_outcomes == outcome_var])) 
int_plot %>%
    ggplot(aes(x= reorder(variable, reduction), y = reduction)) +
    geom_bar(stat = "identity") + coord_flip() + ylim(c(0,1))+
    theme_bw(base_size = 6) + ylab('Relative Importance') + xlab('') +
    ylab(names(vul_outcomes[vul_outcomes == outcome_var])) +
    facet_wrap(method~.) 

}

plot_1 <- varimp_int_fun(outcome_var = vul_outcomes[1]) + ylab('Variable importance vulnerability summer temperature')
ggsave('05_Publikation/vul_efficacy/data/method_data/varimp_interact_1.png', plot_1, width = 9, height = 9, dpi = 900)
plot_2 <- varimp_int_fun(outcome_var = vul_outcomes[2])+ylab('Variable importance vulnerability winter temperature')
ggsave('05_Publikation/vul_efficacy/data/method_data/varimp_interact_2.png', plot_2, width = 9, height = 9, dpi = 900)
plot_3 <- varimp_int_fun(outcome_var = vul_outcomes[3])+ylab('Variable importance vulnerability decreasing rainfall')
ggsave('05_Publikation/vul_efficacy/data/method_data/varimp_interact_3.png', plot_3, width = 9, height = 9, dpi = 900)
plot_4 <- varimp_int_fun(outcome_var = vul_outcomes[4])+ylab('Variable importance vulnerability drought')
ggsave('05_Publikation/vul_efficacy/data/method_data/varimp_interact_4.png', plot_4, width = 9, height = 9, dpi = 900)
plot_5 <- varimp_int_fun(outcome_var = vul_outcomes[5])+ylab('Variable importance vulnerability extreme weather')
ggsave('05_Publikation/vul_efficacy/data/method_data/varimp_interact_5.png',plot_5, width = 9, height = 9, dpi = 900)
varimp_plot_interact <- grid.arrange(plot_1, plot_2,plot_3,plot_4,plot_5,layout_matrix = rbind(c(1,2, NA), c(3,4,5)))
ggsave('05_Publikation/vul_efficacy/data/method_data/varimp_interact.png', varimp_plot_interact, width = 9, height = 9, dpi = 900)
big_varimp_int %>% mutate(model = 'mbh int', variable = as.character(variable)) %>% select(-blearner) %>%
  bind_rows(big_varimp_int_exp %>% mutate(model = 'mb int', variable = as.character(variable)) %>% select(-blearner,-"str_detect(variable, \",\")",)) %>%
  filter(variables == 'no_vul', str_detect(outcome, '_no')) %>%
    group_by(outcome, model) %>%
    slice(1) %>%
  mutate(perc = round(100*n/1366,2))
  

# helper functions for plotting interactions
three_fun <- function(x_name, x_var, group_name, group_var, high_cat_name_group ='Yes',
                      low_cat_name_group = 'No', high_cat_name_x ='Yes',
                      low_cat_name_x = 'No', outcome = '', outcome_name = ''){
  three_model <- glm(formula = as.formula(paste0(outcome, '~', x_var,'*', group_var,'*Country')), data = model_df, binomial('logit'))
  three_model_all <- glm(formula = paste0(outcome, '~', x_var,'*', group_var), data = model_df, binomial('logit'))
  three <- model_df %>%
    mutate('Well_being' = predict(three_model, type = 'response')) %>%
    rbind(
      model_df %>% 
        mutate('Well_being' = predict(three_model_all, type = 'response'),
               Country = 'Chile & Tunisia')
    ) %>%
    mutate(x_axis = case_when(get(x_var) == 'TRUE' ~ high_cat_name_x, T ~low_cat_name_x),
           group_axis = case_when(get(group_var) == 'TRUE' ~ high_cat_name_group, T ~low_cat_name_group)
    )
  three_model_all %>%
    odds.ratio() %>% 
    as.data.frame() %>% rownames_to_column() %>%
    mutate(region = 'All') %>%
    rbind(
      glm(formula = paste0(outcome, '~', x_var,'*', group_var), 
          data = model_df %>% filter(Country == 'Tunisia'), binomial('logit')) %>%
        odds.ratio() %>% 
        as.data.frame() %>% rownames_to_column() %>%
        mutate(region = 'Tunisia')
    ) %>%
    rbind(
      glm(formula = paste0(outcome, '~', x_var,'*', group_var), 
          data = model_df %>% filter(Country == 'Chile'), binomial('logit')) %>%
        odds.ratio() %>% 
        as.data.frame() %>% rownames_to_column() %>%
        mutate(region = 'Chile')
    ) %>%
    write.xlsx(paste0('05_Publikation/vul_efficacy/data/method_data/three/three_',outcome,'_',x_var,'_', group_var,'.xlsx'))
  
  ret <- three %>%
    ggplot(aes_string(y = 'Well_being', color = 'group_axis', x = 'x_axis', group = 'group_axis')) +
    geom_point(size = 3) + geom_line(aes_string(x = 'x_axis')) +
    theme_bw(base_size = 14) + facet_wrap(.~Country) +
    scale_color_manual(values = c("#000000", "#CC79A7")) +
    guides(color=guide_legend(group_name)) +
    ylab(outcome_name) + xlab(x_name) + theme(legend.position = 'top')
  ggsave(paste0('05_Publikation/vul_efficacy/data/1_4/three_',x_var,'_', group_var,'.pdf'), width = 7, height = 5, dpi = 600)
  ggsave(paste0('05_Publikation/vul_efficacy/data/1_4/three_',x_var,'_', group_var,'.png'), width = 7, height = 5, dpi = 600)
  return(ret)
}
three_fun_sum <- function(x_name, x_var, group_name, group_var, high_cat_name_group ='Yes',
                      low_cat_name_group = 'No', high_cat_name_x ='Yes',
                      low_cat_name_x = 'No', outcome = '', outcome_name = ''){
  three_model <- glm(formula = as.formula(paste0(outcome, '~', x_var,'*', group_var,'*Country')), data = model_df, binomial('logit'))
  three_model_all <- glm(formula = paste0(outcome, '~', x_var,'*', group_var), data = model_df, binomial('logit'))
  three <- model_df %>%
    mutate('Well_being' = predict(three_model, type = 'response')) %>%
    mutate(x_axis = get(x_var),
           group_axis = case_when(get(group_var) == 'TRUE' ~ high_cat_name_group, T ~low_cat_name_group)
    )
  three_model_all %>%
    odds.ratio() %>% 
    as.data.frame() %>% rownames_to_column() %>%
    mutate(region = 'All') %>%
    rbind(
      glm(formula = paste0(outcome, '~', x_var,'*', group_var), 
          data = model_df %>% filter(Country == 'Tunisia'), binomial('logit')) %>%
        odds.ratio() %>% 
        as.data.frame() %>% rownames_to_column() %>%
        mutate(region = 'Tunisia')
    ) %>%
    rbind(
      glm(formula = paste0(outcome, '~', x_var,'*', group_var), 
          data = model_df %>% filter(Country == 'Chile'), binomial('logit')) %>%
        odds.ratio() %>% 
        as.data.frame() %>% rownames_to_column() %>%
        mutate(region = 'Chile')
    ) %>%
    write.xlsx(paste0('05_Publikation/vul_efficacy/data/method_data/three/three_',outcome,'_',x_var,'_', group_var,'.xlsx'))
  
  ret <- three %>%
    ggplot(aes_string(y = 'Well_being', color = 'group_axis', x = 'x_axis', group = 'group_axis')) +
    geom_point(size = 3) + geom_line(aes_string(x = 'x_axis')) +
    theme_bw(base_size = 14) + facet_wrap(.~Country) +
    scale_color_manual(values = c("#000000", "#CC79A7")) +
    guides(color=guide_legend(group_name)) +
    ylab(outcome_name) + xlab(x_name) + theme(legend.position = 'top')
  ggsave(paste0('05_Publikation/vul_efficacy/data/1_4/three_',x_var,'_', group_var,'.pdf'), width = 7, height = 5, dpi = 600)
  ggsave(paste0('05_Publikation/vul_efficacy/data/1_4/three_',x_var,'_', group_var,'.png'), width = 7, height = 5, dpi = 600)
  return(ret)
}
three_fun_sum_odds <- function(x_name, x_var, group_name, group_var, high_cat_name_group ='Yes',
                          low_cat_name_group = 'No', high_cat_name_x ='Yes',
                          low_cat_name_x = 'No', outcome = '', outcome_name = ''){
  three_model <- glm(formula = as.formula(paste0(outcome, '~', x_var,'*', group_var,'*Country')), data = model_df, binomial('logit'))
  three_model_all <- glm(formula = paste0(outcome, '~', x_var,'*', group_var), data = model_df, binomial('logit'))
  three <- model_df %>%
    mutate('Well_being' = predict(three_model, type = 'response')) %>%
    mutate(x_axis = get(x_var),
           group_axis = case_when(get(group_var) == 'TRUE' ~ high_cat_name_group, T ~low_cat_name_group,),
           Well_being = log(Well_being/(1-Well_being))
    )
  ret <- three %>%
    ggplot(aes_string(y = 'Well_being', color = 'group_axis', x = 'x_axis', group = 'group_axis')) +
    geom_point(size = 3) + geom_line(aes_string(x = 'x_axis')) +
    theme_bw(base_size = 14) + facet_wrap(.~Country) +
    scale_color_manual(values = c("#000000", "#CC79A7")) +
    guides(color=guide_legend(group_name)) +
    ylab(outcome_name) + xlab(x_name) + theme(legend.position = 'top')
  ggsave(paste0('05_Publikation/vul_efficacy/data/1_4/three_',x_var,'_', group_var,'.pdf'), width = 7, height = 5, dpi = 600)
  ggsave(paste0('05_Publikation/vul_efficacy/data/1_4/three_',x_var,'_', group_var,'.png'), width = 7, height = 5, dpi = 600)
  return(ret)
}


big_varimp_int %>%
  filter(variables == 'all', outcome %in% c('S2.2c', 'S2.3c', 'S2.4c', 'S2.3c_no', 'S2.5c_no', 'S2.6c_no')) %>%
  group_by(outcome) %>%
  slice(1:4) %>%
  clean_names() %>%
  select(variable, outcome, reduction) %>%
  mutate(reduction = round(reduction, 2)) %>%
  write.xlsx('05_Publikation/vul_efficacy/data/1_4_summary/varimp_interaction.xlsx')

# plotting various interactions. Not all are reported in the manuscript.
# Figure 4 start
model_df <- model_df %>%
  mutate('NorthernRegion' = case_when(str_detect(reg, 'NorthernTunisia') ~ 'TRUE',
                                      str_detect(reg, 'CentralChile') ~ 'TRUE',
                                      T ~ 'FALSE'))
top <- three_fun_sum(x_name = 'Vulnerability index', x_var = 'S2.2c_sum', group_name = 'Increasing extreme weather',
                          group_var = 'S2.1d1', outcome = 'S2.2c', 
                          outcome_name = 'Probability summer temperature vulnerability') + ylim(c(0, 1))
bottom <- three_fun_sum_odds(x_name = 'Vulnerability index', x_var = 'S2.2c_sum', group_name = 'Increasing extreme weather',
                     group_var = 'S2.1d1', outcome = 'S2.2c', 
                     outcome_name = 'Log odds summer temperature vulnerability') 
three_temp <- grid.arrange(top,bottom,
                           layout_matrix = rbind(c(1), c(2)))
ggsave('05_Publikation/vul_efficacy/data/1_4_summary/extreme_weather_index_2.png', three_temp, width = 9, height = 9, dpi = 900)
# figure 4 end
top_right <- three_fun_sum(x_name = 'Resilience scale', x_var = 'S2.5c_no_sum', group_name = 'Northern Region',
                           group_var = 'NorthernRegion', outcome = 'S2.5c_no', 
                           outcome_name = 'Probability no drought vulnerability') + ylim(c(0, 1))
three_temp <- grid.arrange(top_left, top_right,
                           layout_matrix = rbind(c(1, 2)))
ggsave('05_Publikation/vul_efficacy/data/1_4_summary/fig_0.png', three_temp, width = 9, height = 4.5, dpi = 900)


top_left <- three_fun_sum(x_name = 'Vulnerability scale', x_var = 'S2.2c_sum', group_name = 'Increasing extreme weather',
                      group_var = 'S2.1d1', outcome = 'S2.2c', 
                      outcome_name = 'Probability summer temperature vulnerability') + ylim(c(0, 1))
top_right <- three_fun(x_name = 'No extreme weather vulnerability', x_var = 'S2.6c_no', group_name = 'Increasing extreme weather',
                       group_var = 'S2.1d1', outcome = 'S2.2c', 
                       outcome_name = 'Probability summer temperature vulnerability') + ylim(c(0, 1))
bottom_left <- three_fun_sum(x_name = 'Vulnerability scale', x_var = 'S2.3c_sum', group_name = 'Agronomic measures',
                       group_var = 'A3', outcome = 'S2.3c', 
                       outcome_name = 'Probability winter temperature vulnerability') + ylim(c(0, 1))
bottom_right <- three_fun(x_name = 'No summer temperature vulnerability', x_var = 'S2.2c_no', group_name = 'Technological measures',
                          group_var = 'T3', outcome = 'S2.3c', 
                          outcome_name = 'Probability summer temperature vulnerability') + ylim(c(0, 1))
three_temp <- grid.arrange(top_left, top_right, bottom_left, bottom_right,
                           layout_matrix = rbind(c(1, 2), c(3,4)))
ggsave('05_Publikation/vul_efficacy/data/1_4_summary/fig_1.png', three_temp, width = 9, height = 9, dpi = 900)
top_left <- three_fun(x_name = 'No winter temperature vulnerability', x_var = 'S2.2c_no', group_name = 'Northern Region',
                      group_var = 'NorthernRegion', outcome = 'S2.4c', 
                      outcome_name = 'Probability percipitation vulnerability') + ylim(c(0, 1))
top_right <- three_fun_sum(x_name = 'Vulnerability scale', x_var = 'S2.4c_sum', group_name = 'Agronomic measures',
                           group_var = 'A3', outcome = 'S2.4c', 
                           outcome_name = 'Probability percipitation vulnerability') + ylim(c(0, 1))
bottom_left <- three_fun(x_name = 'No summer temperature vulnerability', x_var = 'S2.2c_no', group_name = 'Northern Region',
                        group_var = 'NorthernRegion', outcome = 'S2.3c_no', 
                        outcome_name = 'Probability no winter temperature vulnerability') + ylim(c(0, 1))
bottom_right <- three_fun_sum(x_name = 'Resilience scale', x_var = 'S2.3c_no_sum', group_name = 'Technological measures',
                              group_var = 'T3', outcome = 'S2.3c_no', 
                              outcome_name = 'Probability no winter temperature vulnerability') + ylim(c(0, 1))
three_temp <- grid.arrange(top_left, top_right, bottom_left, bottom_right,
                           layout_matrix = rbind(c(1, 2), c(3,4)))
ggsave('05_Publikation/vul_efficacy/data/1_4_summary/fig_2.png', three_temp, width = 9, height = 9, dpi = 900)
top_left <- three_fun(x_name = 'No summer temperature vulnerability', x_var = 'S2.2c_no', group_name = 'Northern Region',
                      group_var = 'NorthernRegion', outcome = 'S2.5c_no', 
                      outcome_name = 'Probability no drought vulnerability') + ylim(c(0, 1))
top_right <- three_fun_sum(x_name = 'Resilience scale', x_var = 'S2.5c_no_sum', group_name = 'Northern Region',
                           group_var = 'NorthernRegion', outcome = 'S2.5c_no', 
                           outcome_name = 'Probability no drought vulnerability') + ylim(c(0, 1))
bottom_left <- three_fun(x_name = 'No summer temperature vulnerability', x_var = 'S2.2c_no', group_name = 'Northern Region',
                         group_var = 'NorthernRegion', outcome = 'S2.6c_no', 
                         outcome_name = 'Probability no extreme weather vulnerability') + ylim(c(0, 1))
bottom_right <- three_fun_sum(x_name = 'Trust in TV', x_var = 'S1.9c', group_name = 'Farm size',
                              group_var = 'S8.6a', outcome = 'S2.6c_no', 
                              outcome_name = 'Probability no extreme weather vulnerability') + ylim(c(0, 1))
three_temp <- grid.arrange(top_left, top_right, bottom_left, bottom_right,
                           layout_matrix = rbind(c(1, 2), c(3,4)))
ggsave('05_Publikation/vul_efficacy/data/1_4_summary/fig_3.png', three_temp, width = 9, height = 9, dpi = 900)
######################################################################### Method
# S2.2c




top_left <- three_fun(x_name = 'High optimism', x_var = 'S1.2c', group_name = 'More than one variety grown',
                      group_var = 'S8.6c', outcome = 'S2.2c_no', 
                      outcome_name = 'Probability no vulnerability') + ylim(c(0, 1))
top_right <-  three_fun(x_name = 'Trust in extension workers', x_var = 'S1.9f', group_name = 'Northern Region',
                        group_var = 'Northern', outcome = 'S2.2c_no', 
                        outcome_name = 'Probability no vulnerability') + ylim(c(0, 1))
bottom_left <-  three_fun(x_name = 'Economic measures', x_var = 'F3', group_name = 'Prior ownership (family)',
                          group_var = 'S8.2balternative', outcome = 'S2.2c_no', 
                          outcome_name = 'Probability novulnerability') + ylim(c(0, 1))
bottom_right <-  three_fun(x_name = 'Agronomic measures', x_var = 'A3', group_name = 'Trust in government',
                           group_var = 'S1.9g', outcome = 'S2.2c_no', 
                           outcome_name = 'Probability no vulnerability') + ylim(c(0, 1))

three_temp <- grid.arrange(top_left, top_right, bottom_left, bottom_right,
                           layout_matrix = rbind(c(1, 2), c(3,4)))
ggsave('05_Publikation/vul_efficacy/data/method_data/S2.2c.png', three_temp, width = 9, height = 9, dpi = 900)
# S2.3c
top_left <- three_fun(x_name = 'Be in profitable business', x_var = 'S1.1e', group_name = 'Northern Region',
                      group_var = 'Northern', outcome = 'S2.3c_no', 
                      outcome_name = 'Probability no vulnerability') + ylim(c(0, 1))
top_right <-  three_fun(x_name = 'Farm debt load', x_var = 'S8.14', group_name = 'Northern Region',
                        group_var = 'Northern', outcome = 'S2.3c_no', 
                        outcome_name = 'Probability no vulnerability') + ylim(c(0, 1))
bottom_right <-  three_fun(x_name = 'Farm debt load', x_var = 'S8.14', group_name = 'Prior ownership (family)',
                          group_var = 'S8.2balternative', outcome = 'S2.3c_no', 
                          outcome_name = 'Probability no vulnerability') + ylim(c(0, 1))
bottom_left <-  three_fun(x_name = 'Be in profitable business', x_var = 'S1.1e', group_name = 'Use of well',
                           group_var = 'S8.11_well', outcome = 'S2.3c_no', 
                           outcome_name = 'Probability no vulnerability') + ylim(c(0, 1))

three_temp <- grid.arrange(top_left, top_right, bottom_left, bottom_right,
                           layout_matrix = rbind(c(1, 2), c(3,4)))
ggsave('05_Publikation/vul_efficacy/data/method_data/S2.3c.png', three_temp, width = 9, height = 9, dpi = 900)
# S2.4c
top_left <- three_fun(x_name = 'Agronomic measures', x_var = 'A3', group_name = 'Trust in TV and magazines',
                      group_var = 'S1.9c', outcome = 'S2.4c_no', 
                      outcome_name = 'Probability no vulnerability') + ylim(c(0, 1))
top_right <-  three_fun(x_name = 'High certainty', x_var = 'S1.3f', group_name = 'Northern Region',
                        group_var = 'Northern', outcome = 'S2.4c_no', 
                        outcome_name = 'Probability no vulnerability') + ylim(c(0, 1))
bottom_left <-  three_fun(x_name = 'Years of farm possession >1', x_var = 'S8.2a2', group_name = 'Northern Region',
                          group_var = 'Northern', outcome = 'S2.4c_no', 
                          outcome_name = 'Probability no vulnerability') + ylim(c(0, 1))
bottom_right <-  three_fun(x_name = 'Climate change is harmful', x_var = 'S1.2a', group_name = 'Northern Region',
                           group_var = 'Northern', outcome = 'S2.4c_no', 
                          outcome_name = 'Probability no vulnerability') + ylim(c(0, 1))

three_temp <- grid.arrange(top_left, top_right, bottom_left, bottom_right,
                           layout_matrix = rbind(c(1, 2), c(3,4)))
ggsave('05_Publikation/vul_efficacy/data/method_data/S2.4c.png', three_temp, width = 9, height = 9, dpi = 900)
# S2.5c
top_left <- three_fun(x_name = 'More than one variety grown', x_var = 'S8.6c' , group_name = 'Northern Region',
                      group_var = 'Northern', outcome = 'S2.5c_no', 
                      outcome_name = 'Probability no vulnerability') + ylim(c(0, 1))
top_right <-  three_fun(x_name = 'Increasing drought', x_var = 'S2.1c1', group_name = 'Northern Region',
                        group_var = 'Northern', outcome = 'S2.5c_no', 
                        outcome_name = 'Probability no vulnerability') + ylim(c(0, 1))
bottom_left <-  three_fun(x_name = 'Increasing temperature', x_var = 'S2.1a1', group_name = 'Northern Region',
                          group_var = 'Northern', outcome = 'S2.5c_no', 
                          outcome_name = 'Probability no vulnerability') + ylim(c(0, 1))
bottom_right <-  three_fun(x_name = 'Provide good living environment', x_var = 'S1.1d', group_name = 'Adaptive measure efficacy',
                           group_var = 'S3.4', outcome = 'S2.5c_no', 
                           outcome_name = 'Probability no vulnerability') + ylim(c(0, 1))

three_temp <- grid.arrange(top_left, top_right, bottom_left, bottom_right,
                           layout_matrix = rbind(c(1, 2), c(3,4)))
ggsave('05_Publikation/vul_efficacy/data/method_data/S2.5c.png', three_temp, width = 9, height = 9, dpi = 900)
# S2.6c
top_left <- three_fun(x_name = 'Farm size >7h', x_var = 'S8.6a' , group_name = 'Trust in TV and magazines',
                      group_var = 'S1.9c', outcome = 'S2.6c_no', 
                      outcome_name = 'Probability no vulnerability') + ylim(c(0, 1))
top_right <-  three_fun(x_name = 'Increasing extreme weather', x_var = 'S2.1a1', group_name = 'More than one variety grown',
                        group_var = 'S8.6c', outcome = 'S2.6c_no', 
                        outcome_name = 'Probability no vulnerability') + ylim(c(0, 1))
bottom_left <-  three_fun(x_name = 'Years of farm possession >1', x_var = 'S8.2a2', group_name = 'Northern Region',
                          group_var = 'Northern', outcome = 'S2.6c_no', 
                          outcome_name = 'Probability no vulnerability') + ylim(c(0, 1))
bottom_right <- three_fun(x_name = 'Income invested >80%', x_var = 'S3.3', group_name = 'Low financial wellbeing',
                           group_var = 'S8.13_low', outcome = 'S2.6c_no', 
                           outcome_name = 'Probability no vulnerability') + ylim(c(0, 1))

three_temp <- grid.arrange(top_left, top_right, bottom_left, bottom_right,
                           layout_matrix = rbind(c(1, 2), c(3,4)))
ggsave('05_Publikation/vul_efficacy/data/method_data/S2.6c.png', three_temp, width = 9, height = 9, dpi = 900)
######################################################################### Method
#S2.3c

top_left <- three_fun(x_name = 'S1.1c', x_var = 'S1.1c', group_name = 'reg',
                      group_var = 'reg', outcome = 'S2.3c', outcome_name = 'S2.3c') + ylim(c(0, 1))
top_right <- three_fun(x_name = 'T3', x_var = 'T3', group_name = 'S2.2c',
                       group_var ='S2.2c', outcome = 'S2.3c', outcome_name = 'S2.3c') + ylim(c(0, 1))
bottom_left <- three_fun(x_name = 'S1.8c', x_var = 'S1.8c', group_name = 'S2.2c',
                         group_var = 'S2.2c', outcome = 'S2.3c', outcome_name = 'S2.3c') + ylim(c(0, 1))
bottom_right <-  three_fun(x_name = 'S2.1c1', x_var = 'S2.1c1', group_name = 'S2.2c',
                           group_var = 'S2.2c', outcome = 'S2.3c', outcome_name = 'S2.3c') + ylim(c(0, 1))
bottom_bottom <-  three_fun(x_name = 'S2.1b3', x_var = 'S2.1b3', group_name = 'S2.2c',
                           group_var = 'S2.2c', outcome = 'S2.3c', outcome_name = 'S2.3c') + ylim(c(0, 1))

three_temp <- grid.arrange(top_left, top_right, bottom_left, bottom_right, bottom_bottom,
                           layout_matrix = rbind(c(1, 2), c(3,4),c(5,6)))
ggsave('05_Publikation/vul_efficacy/data/1_4_summary/S2.3c.pdf', three_temp, width = 9, height = 9, dpi = 600)
ggsave('05_Publikation/vul_efficacy/data/1_4_summary/S2.3c.png', three_temp, width = 9, height = 9, dpi = 600)

#S2.4c

top_left <- three_fun(x_name = 'A3', x_var = 'A3', group_name = 'S2.2c',
                      group_var = 'S2.2c', outcome = 'S2.4c', outcome_name = 'S2.4c') + ylim(c(0, 1))
top_right <- three_fun(x_name = 'A3', x_var = 'A3', group_name = 'S2.2c_no',
                       group_var = 'S2.2c_no', outcome = 'S2.4c', outcome_name = 'S2.4c') + ylim(c(0, 1))
bottom_left <- three_fun(x_name = 'S1.2c', x_var = 'S1.2c', group_name = 'S2.5c',
                         group_var = 'S2.5c', outcome = 'S2.4c', outcome_name = 'S2.4c') + ylim(c(0, 1))
bottom_right <-  three_fun(x_name = 'S1.3f', x_var = 'S1.3f', group_name = 'S1.1c',
                           group_var = 'S1.1c', outcome = 'S2.4c', outcome_name = 'S2.4c') + ylim(c(0, 1))
bottom_bottom <-  three_fun(x_name = 'A3', x_var = 'A3', group_name = 'S1.1c',
                            group_var = 'S1.1c', outcome = 'S2.4c', outcome_name = 'S2.4c') + ylim(c(0, 1))

three_temp <- grid.arrange(top_left, top_right, bottom_left, bottom_right, bottom_bottom,
                           layout_matrix = rbind(c(1, 2), c(3,4),c(5,6)))
ggsave('05_Publikation/vul_efficacy/data/1_4_summary/S2.4c.pdf', three_temp, width = 9, height = 9, dpi = 600)
ggsave('05_Publikation/vul_efficacy/data/1_4_summary/S2.4c.png', three_temp, width = 9, height = 9, dpi = 600)

#S2.5c
model_df <- model_df %>%
  mutate(S8.1d = relevel(as.factor(S8.1d == '3'), ref = 'FALSE'))

top_left <- three_fun(x_name = 'S1.2c', x_var = 'S1.2c', group_name = 'More than one variety grown',
                      group_var = 'S8.6c', outcome = 'S2.2c_no', 
                      outcome_name = 'Probability no summer teperature vulnerability') + ylim(c(0, 1))
top_right <-  three_fun(x_name = 'Northern', x_var = 'S1.2c', group_name = 'More than one variety grown',
                        group_var = 'S8.6c', outcome = 'S2.2c_no', 
                        outcome_name = 'Probability no summer teperature vulnerability') + ylim(c(0, 1))
bottom_left <-  three_fun(x_name = 'S1.2c', x_var = 'S1.2c', group_name = 'More than one variety grown',
                          group_var = 'S8.6c', outcome = 'S2.2c_no', 
                          outcome_name = 'Probability no summer teperature vulnerability') + ylim(c(0, 1))
bottom_right <-  three_fun(x_name = 'S1.2c', x_var = 'S1.2c', group_name = 'More than one variety grown',
                           group_var = 'S8.6c', outcome = 'S2.2c_no', 
                           outcome_name = 'Probability no summer teperature vulnerability') + ylim(c(0, 1))

three_temp <- grid.arrange(top_left, top_right, bottom_left, bottom_right,
                           layout_matrix = rbind(c(1, 2), c(3,4)))
ggsave('05_Publikation/vul_efficacy/data/method_data/S2.2c.pdf', three_temp, width = 9, height = 9, dpi = 600)
ggsave('05_Publikation/vul_efficacy/data/1_4_summary/S2.5c.png', three_temp, width = 9, height = 9, dpi = 600)

#S2.6c

top_left <- three_fun(x_name = 'S2.1d1', x_var = 'S2.1d1', group_name = 'S2.4c',
                      group_var = 'S2.4c', outcome = 'S2.6c', outcome_name = 'S2.6c') + ylim(c(0, 1))
top_right <- three_fun(x_name = 'S2.1d1', x_var = 'S2.1d1', group_name = 'S8.6c',
                       group_var = 'S8.6c', outcome = 'S2.6c', outcome_name = 'S2.6c') + ylim(c(0, 1))
bottom_left <- three_fun(x_name = 'S5.17d', x_var = 'S5.17d', group_name = 'S1.8j',
                         group_var = 'S1.8j', outcome = 'S2.6c', outcome_name = 'S2.6c') + ylim(c(0, 1))

three_temp <- grid.arrange(top_left, top_right, bottom_left,
                           layout_matrix = rbind(c(1, 2), c(3,4)))
ggsave('05_Publikation/vul_efficacy/data/1_4_summary/S2.6c.pdf', three_temp, width = 9, height = 9, dpi = 600)
ggsave('05_Publikation/vul_efficacy/data/1_4_summary/S2.6c.png', three_temp, width = 9, height = 9, dpi = 600)

#S2.2c_no

top_left <- three_fun(x_name = 'S3.4', x_var = 'S3.4', group_name = 'S8.14',
                      group_var = 'S8.14', outcome = 'S2.3c_no', outcome_name = 'S2.3c_no') + ylim(c(0, 1))
top_right <- three_fun(x_name = 'S3.1a', x_var = 'S3.1a', group_name = 'F3',
                       group_var = 'F3', outcome = 'S2.3c_no', outcome_name = 'S2.3c_no') + ylim(c(0, 1))
bottom_left <- three_fun(x_name = 'S2.2c_proximity', x_var = 'S2.2c_proximity', group_name = 'S8.14',
                         group_var = 'S8.14', outcome = 'S2.3c_no', outcome_name = 'S2.3c_no') + ylim(c(0, 1))

three_temp <- grid.arrange(top_left, top_right, bottom_left,
                           layout_matrix = rbind(c(1, 2), c(3,4)))
ggsave('05_Publikation/vul_efficacy/data/1_4_summary/S2.3c_no.pdf', three_temp, width = 9, height = 9, dpi = 600)
ggsave('05_Publikation/vul_efficacy/data/1_4_summary/S2.3c_no.png', three_temp, width = 9, height = 9, dpi = 600)

#S2.5c_no

top_left <- three_fun(x_name = 'S1.1d', x_var = 'S1.1d', group_name = 'S3.4',
                      group_var = 'S3.4', outcome = 'S2.5c_no', outcome_name = 'S2.5c_no') + ylim(c(0, 1))
top_right <- three_fun(x_name = 'S2.4c_no', x_var = 'S2.4c_no', group_name = 'S1.2c',
                       group_var = 'S1.2c', outcome = 'S2.5c_no', outcome_name = 'S2.5c_no') + ylim(c(0, 1))
bottom_left <- three_fun(x_name = 'S8.3b', x_var = 'S8.3b', group_name = 'S3.3',
                         group_var = 'S3.3', outcome = 'S2.5c_no', outcome_name = 'S2.5c_no') + ylim(c(0, 1))

three_temp <- grid.arrange(top_left, top_right, bottom_left,
                           layout_matrix = rbind(c(1, 2), c(3,4)))
ggsave('05_Publikation/vul_efficacy/data/1_4_summary/S2.5c_no.pdf', three_temp, width = 9, height = 9, dpi = 600)
ggsave('05_Publikation/vul_efficacy/data/1_4_summary/S2.5c_no.png', three_temp, width = 9, height = 9, dpi = 600)


# 3way final

three_fun(x_name = '2.4c', x_var = 'S2.4c', group_name = 'S2.2c',
          group_var = 'S2.2c', outcome = 'S2.6c', outcome_name = 'S2.6c') + ylim(c(0, 1))
three_fun(x_name = 'S2.2c', x_var = 'S2.2c', group_name = 'S2.4c',
          group_var = 'S2.4c', outcome = 'S2.6c', outcome_name = 'S2.6c') + ylim(c(0, 1))
three_fun(x_name = 'S2.2c', x_var = 'S2.4c', group_name = 'S2.4c',
          group_var = 'S2.4c', outcome = 'S2.5c', outcome_name = '2.5c') + ylim(c(0, 1))
three_fun(x_name = 'S2.2c', x_var = 'S2.2c', group_name = 'S1.2a',
          group_var = 'S1.2a', outcome = 'S2.4c', outcome_name = '2.4c') + ylim(c(0, 1))
three_fun(x_name = 'S8.13', x_var = 'S8.13', group_name = 'S8.14',
          group_var = 'S8.14', outcome = 'S2.4c', outcome_name = 'S2.4c') + ylim(c(0, 1))
three_fun(x_name = '8.6c', x_var = 'S8.6c', group_name = 'S8.6a',
          group_var = 'S8.6a', outcome = 'S2.4c', outcome_name = '2.4c') + ylim(c(0, 1))
three_fun(x_name = 'S2.1b3', x_var = 'S2.1b3', group_name = 'S2.1a1',
          group_var = 'S2.1a1', outcome = 'S2.4c', outcome_name = 'S2.4c') + ylim(c(0, 1))
three_fun(x_name = 'S2.4c', x_var = 'S2.4c', group_name = 'S8.14',
          group_var = 'S8.14', outcome = 'S2.3c', outcome_name = 'S2.3c') + ylim(c(0, 1))
three_fun(x_name = 'S2.2c', x_var = 'S2.2c', group_name = 'S8.14',
          group_var = 'S8.14', outcome = 'S2.3c', outcome_name = 'S2.3c') + ylim(c(0, 1))
three_fun(x_name = 'S8.6c', x_var = 'S8.6c', group_name = 'S8.6a',
          group_var = 'S8.6a', outcome = 'S2.2c', outcome_name = 'S2.2c') + ylim(c(0, 1))
three_fun(x_name = 'S2.4c_no', x_var = 'S2.4c_no', group_name = 'S2.6c_no',
          group_var = 'S2.6c_no', outcome = 'S2.2c_no', outcome_name = 'S2.2c_no') + ylim(c(0, 1))
three_fun(x_name = 'S2.3c_no', x_var = 'S2.3c_no', group_name = 'S2.6c_no',
          group_var = 'S2.6c_no', outcome = 'S2.4c_no', outcome_name = 'S2.4c_no') + ylim(c(0, 1))


